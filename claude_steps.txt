Hi Claude. You are building Praxis, as outlined in the whitepaper PDF. This file serves as your memory and development log across sessions. Modify it to set goals, track progress, record architectural decisions, and note anything useful.
You can delegate tasks to gemini. Remember to git commit and andit this file at the end of each session.
---

## Handoff from Gemini

Previous development (Sessions 1‚Äì9) was completed by Gemini CLI. The following features were implemented and are considered stable:

- Backend Express server with 10 route modules (auth, users, goals, matches, messages, feedback, achievements, stripe, AI coaching, analytics)
- Supabase auth + profiles table integration
- GoalTree CRUD with achievement auto-creation on goal completion
- Peer feedback submission with dynamic weight recalibration (whitepaper ¬ß3.5)
- MatchingEngineService using Gemini embeddings + cosine similarity (whitepaper ¬ß3.3)
- Stripe Checkout + webhook premium subscription flow
- AI Coaching via Gemini generative model (premium-gated)
- Advanced Analytics endpoints (premium-gated)
- Centralized error handling (appErrors.ts + errorHandler middleware)
- Winston logging throughout backend
- GoalTreeComponent visualization with Framer Motion animations
- Basic DashboardPage with achievements, comments, voting

---

## Session 17 ‚Äî Claude Code (2026-02-20 cont.) ‚Äî Phase 1 stability + GoalTree redesign

### Completed this session:
- **GoalTree SVG visualization** (`GoalTreeVisualization.tsx`):
  - Bottom-up tree: root circle (member-since date) at base of stem
  - Each root goal = colored branch in domain color (DOMAIN_COLORS from types/goal.ts)
  - Sub-goals branch further UP (incremental); siblings spread HORIZONTALLY
  - Progress arc on each node (strokeDasharray, rotated -90¬∞); fill opacity ‚àù progress
  - Glow ring when ‚â•75% complete; full glow + solid stroke at 100%
  - Click node with children to collapse/expand subtree
  - `GoalTreePage.tsx` now uses GoalTreeVisualization + fetches auth.user.created_at
- **ChatRoom polish**:
  - Partner messages: small avatar circle + name label above each bubble
  - Typing indicator: 3-dot bounce animation via Supabase Broadcast channel
    - `typing` event broadcast on keypress; auto-clears after 3s silence
    - `self: false` in channel config so own typing events are ignored
- TypeScript: 0 errors frontend + backend

### Next priorities (Phase 1 remaining):
- Phase 1D: responsive pass on GoalSelectionPage + OnboardingPage
- Phase 2: Real Gemini embeddings for matching (pgvector RPC)
- Phase 2 cont.: Mutual grading stub in chat/profile
- Phase 3: Deploy (Railway + Vercel) after user adds env vars

---

## Session 15 ‚Äî Claude Code (2026-02-20) ‚Äî Plan + Overnight Sprint

### What was fixed this session (continued from Session 14):
- `supabaseClient.ts`: Changed env var from `SUPABASE_PUBLISHABLE_KEY` ‚Üí `SUPABASE_SERVICE_ROLE_KEY`
  (backend was using anon key which can't bypass RLS ‚Äî was root cause of all goal tree save errors)
- `goalController.ts`: `select('*')` instead of naming columns (graceful if column missing);
  `getUserProfileDetails` non-fatal (achievement creation shouldn't block goal tree save)
- `manual_actions.txt`: Added `goal_trees` table SQL (Query 1B) ‚Äî was completely missing
- `ProfilePage.tsx`: Added age, sex, location fields to both edit form and view mode
- `.env.example`: Updated to use `SUPABASE_SERVICE_ROLE_KEY` with correct format notes

### Current app state (end of Session 15):
- ‚úÖ New user can register ‚Üí onboard ‚Üí set goal tree ‚Üí access dashboard
- ‚úÖ Goal tree compilation works end-to-end with service role key
- ‚úÖ Profile editing: name, bio, age, sex, location, avatar
- ‚úÖ One free re-edit gate on goal tree (backend + frontend enforced)
- ‚úÖ Matches page shows demo profiles with fallback matching
- ‚úÖ Chat works (real-time with Supabase)
- ‚úÖ TypeScript: 0 errors backend + frontend
- ‚ùå Not deployed (Railway + Vercel steps in manual_actions.txt)
- ‚ùå Stripe PRICE_ID not yet set (upgrade flow fails)
- ‚ùå Demo users not yet seeded
- ‚ùå Mobile layout: Navbar has no hamburger, ChatRoom unsafe for mobile keyboard

---

## Development Plan (as of 2026-02-20)

### üî¥ PHASE 1 ‚Äî Mobile Responsiveness (START TONIGHT)
The most impactful near-term work. Most beta users will be on mobile.

**1A. Navbar hamburger menu** ‚Üê START HERE
- Replace nav links with hamburger IconButton on xs screens
- Slide-in Drawer with same links + close button
- Files: `client/src/components/common/Navbar.tsx`

**1B. ChatRoom mobile keyboard fix**
- Input bar sits above keyboard on mobile: add `paddingBottom: env(safe-area-inset-bottom)`
  to the fixed-bottom input container
- File: `client/src/features/chat/ChatRoom.tsx`

**1C. GoalTree horizontal scroll**
- Wrap GoalTreeComponent in `overflowX: 'auto'` container
- File: `client/src/features/goals/GoalTreePage.tsx`

**1D. General responsive pass**
- Check GoalSelectionPage chip wrapping on small screens
- Check OnboardingPage stepper labels don't overflow

---

### üî¥ PHASE 2 ‚Äî Dashboard Enhancements (TONIGHT)

**2A. Top Matches widget**
- Dashboard already has stats cards; add a "Your Top Matches" section below them
- Fetch top 3 from `GET /matches/:userId`, show avatar + name + compatibility % + "Message" CTA
- Backend: `/matches/:userId` already works ‚Äî just connect it
- File: `client/src/features/dashboard/DashboardPage.tsx`

**2B. Progress Streaks**
- Backend: after any goal tree save, update `last_activity_date` + `current_streak` on profile
- Frontend: flame icon + streak count in Dashboard welcome banner
- SQL migration (add to manual_actions.txt Step 5):
  ```sql
  ALTER TABLE profiles
    ADD COLUMN IF NOT EXISTS last_activity_date DATE,
    ADD COLUMN IF NOT EXISTS current_streak INT DEFAULT 0;
  ```
- Files: `src/controllers/goalController.ts`, `client/src/features/dashboard/DashboardPage.tsx`

---

### üü° PHASE 3 ‚Äî Achievement Flow Completion (NEXT SESSION)

**3A. "Mark Complete" button on GoalTreePage**
- Each root node with progress = 100 shows a "üèÜ Mark Complete" button
- On confirm: POST /achievements + toast "Achievement unlocked!"
- File: `client/src/features/goals/GoalTreePage.tsx`

**3B. Achievement detail modal**
- Click achievement card on Dashboard ‚Üí modal with full details, comments, votes
- Currently all interactions are inline; a modal would clean up the feed significantly
- File: `client/src/features/dashboard/DashboardPage.tsx`

---

### üî¥ PHASE 4 ‚Äî Deployment (NEEDS USER)

**4A. Railway (backend)**
- `PORT` already uses `process.env.PORT || 3001` ‚úÖ
- `Procfile` already exists ‚úÖ
- Push to GitHub ‚Üí connect on railway.app ‚Üí add all backend env vars
- Expected URL: `https://praxis-webapp-production.up.railway.app`

**4B. Vercel (frontend)**
- Set `REACT_APP_API_URL` to Railway URL in Vercel project settings
- `vercel --prod` from `/client`
- Expected URL: `https://praxis.vercel.app` or custom domain

**4C. Post-deploy**
- Update `CLIENT_URL` in Railway env to Vercel URL (for Stripe redirects)
- Register Stripe production webhook ‚Üí add `STRIPE_WEBHOOK_SECRET` to Railway
- Seed demo users: `POST /admin/seed-demo-users` with `X-Admin-Secret` header

---

### üü° PHASE 5 ‚Äî Beta Polish (NEXT WEEK)

**5A. Goal-Focused Match Chat (Step 10) ‚úÖ DONE**
- "Collab" button on MatchCard for score >= 60% real matches ‚Üí navigate to chat
- ChatRoom: "Focus" / "Goal" header button ‚Üí goal picker dialog (user's own nodes)
- Goal focus amber banner between header and feedback collapse
- `sendMessage` includes `goalNodeId` when a focus goal is active
- Feedback form auto-selects focus goal node when opened
- `messages` table: `goal_node_id` column (SQL migration Query 8B in manual_actions.txt)

**5B. Mutual Grading UX (Step 11)**
- Feedback dialog triggered after N messages or "End Session" click
- Show "Waiting for partner" state; only recalibrate weights when both submit

**5C. AI Coaching improvements**
- Currently a plain text input + response; add suggested prompts per domain
- Stream the response instead of waiting for full completion

---

### üü¢ PHASE 6 ‚Äî Growth Features (POST-BETA)

**6A. Progress Streaks visualization** (animated flame in Navbar)
**6B. Community Challenges** (shared goal events, group accountability chat)
**6C. Goal Tree Evolution History** (snapshots, timeline in Analytics)
**6D. Embedding cache** (Redis or `goal_embeddings` table to avoid repeated Gemini calls)

---

## Architectural Notes

- **Auth flow:** Frontend uses anon Supabase client (JWT in browser). Backend API endpoints
  needing auth use `authenticateToken` middleware with service-role Supabase client to verify JWT.
- **Gemini Embeddings cost:** Each `getEmbedding()` call = 1 Gemini API request.
  MatchingEngine calls O(|A.nodes| √ó |B.nodes|) times per user pair.
  Cache in Redis or `goal_embeddings` table for production scale.
- **Goal weight normalization (whitepaper ¬ß3.3):**
  S_AB = Œ£(sim_ij √ó w_i √ó w_j) / Œ£(w_i √ó w_j) over same-domain node pairs.
- **Weight recalibration multipliers (whitepaper ¬ß3.5):**
  SUCCEEDED√ó0.8 | DISTRACTED√ó1.2 | LEARNED√ó0.9 | ADAPTED√ó1.05 | NOT_APPLICABLE√ó1.0
- **Free tier limits:** Max 3 root goals. AI Coaching, Advanced Analytics, unlimited goals = premium only.
- **Supabase RLS:** All tables have RLS. Backend uses service-role key (bypasses RLS).
  Frontend anon key is subject to RLS ‚Äî always test both user perspectives.
- **API_URL pattern:** All frontend axios calls use `${API_URL}` from `client/src/lib/api.ts`.
  Change `REACT_APP_API_URL` in `client/.env` (local) or Vercel env vars (production).
  Never hardcode `localhost:3001`.
- **MUI v7 Grid:** Use `<Grid size={{ xs: N, md: M }}>` not `<Grid item xs={N} md={M}>`.

---

## Environment Variables Checklist

### Backend (`/.env`)
- [x] SUPABASE_URL
- [x] SUPABASE_SERVICE_ROLE_KEY   ‚Üê MUST be service_role, not anon
- [x] STRIPE_SECRET_KEY
- [x] STRIPE_WEBHOOK_SECRET
- [ ] STRIPE_PRICE_ID             ‚Üê still empty, upgrade flow broken
- [ ] GEMINI_API_KEY              ‚Üê optional; fallback matching works without it
- [x] CLIENT_URL
- [x] ADMIN_SECRET
- [x] PORT

### Frontend (`/client/.env`)
- [x] REACT_APP_SUPABASE_URL
- [x] REACT_APP_SUPABASE_ANON_KEY
- [x] REACT_APP_STRIPE_PUBLISHABLE_KEY
- [x] REACT_APP_API_URL
- [x] GENERATE_SOURCEMAP=false

See `manual_actions.txt` for full Supabase + Stripe setup instructions.
