Hi Claude. You are building Praxis, as outlined in the whitepaper PDF. This file serves as your memory and development log across sessions. Modify it to set goals, track progress, record architectural decisions, and note anything useful.

---

## Handoff from Gemini

Previous development (Sessions 1–9) was completed by Gemini CLI. The following features were implemented and are considered stable:

- Backend Express server with 10 route modules (auth, users, goals, matches, messages, feedback, achievements, stripe, AI coaching, analytics)
- Supabase auth + profiles table integration
- GoalTree CRUD with achievement auto-creation on goal completion
- Peer feedback submission with dynamic weight recalibration (whitepaper §3.5)
- MatchingEngineService using Gemini embeddings + cosine similarity (whitepaper §3.3)
- Stripe Checkout + webhook premium subscription flow
- AI Coaching via Gemini generative model (premium-gated)
- Advanced Analytics endpoints (premium-gated)
- Centralized error handling (appErrors.ts + errorHandler middleware)
- Winston logging throughout backend
- GoalTreeComponent visualization with Framer Motion animations
- Basic DashboardPage with achievements, comments, voting

---

## Session 10 — Claude Code Takeover (2026-02-19)

**Scope:** Full audit, critical bug fixes, API connection for stub pages, comprehensive dark theme styling overhaul, code commenting, and development roadmap extension.

### Phase 1 — Critical Bug Fixes (COMPLETED)

1. **Bug 1 — Missing route imports in `src/index.ts`:** Added 8 missing imports:
   - authRoutes, userRoutes, messageRoutes, goalRoutes, matchingRoutes, feedbackRoutes, achievementRoutes, stripeRoutes

2. **Bug 2 — Missing `src/middleware/authenticateToken.ts`:** Created auth middleware:
   - Extracts Bearer token from Authorization header
   - Verifies via `supabase.auth.getUser(token)`
   - Sets `req.user = { id: user.id }` on success
   - Returns 401 UnauthorizedError on failure
   - Also created `src/types/express.d.ts` to extend Request type

3. **Bug 3 — `DashboardPage.tsx` missing commentsLoading state:** Added `const [commentsLoading, setCommentsLoading] = useState(false);`

4. **Bug 4 — `DashboardPage.tsx` wrong import paths:** Fixed `'../models/*'` to `'../../models/*'` for GoalTree, GoalNode, Achievement, AchievementComment

5. **Bug 5 — `DashboardPage.tsx` AI Coaching missing auth header:** Added `supabase.auth.getSession()` + `Authorization: Bearer` header

6. **Bug 6 — `AnalyticsPage.tsx` missing auth headers:** Added auth headers to all 5 analytics axios calls; fixed `useUser` and `supabase` import paths

### Phase 2 — Connect Mock Pages to Real Backend (COMPLETED)

- **GoalTreePage.tsx:** Replaced hardcoded `exampleGoalTreeData` with real `GET /goals/:userId` backend call. Added backend-to-frontend GoalNode mapping (name to title, progress 0-1 to 0-100, flat nodes with parentId to tree with children array). Fixed all import paths.

- **MatchesPage.tsx:** Replaced mock users + fake compatibility with real `GET /matches/:userId` backend. Fetches match scores then loads profiles for display.

### Phase 3 — Comprehensive Styling Overhaul (COMPLETED)

New MUI theme (`client/src/index.tsx`):
- Dark backgrounds: #0A0B14 (default), #111827 (paper)
- Primary: amber-gold #F59E0B
- Secondary: electric violet #8B5CF6
- Typography: Inter (body) + Plus Jakarta Sans (headings) via Google Fonts
- Card radius: 16px, glassmorphism style
- Glow shadows with colored elevation

Created `client/src/components/common/GlassCard.tsx` — reusable glassmorphism card.

Page redesigns: HomePage, Navbar, DashboardPage, GoalTreePage, MatchesPage, ProfilePage, UpgradePage, AnalyticsPage, LoginPage, SignupPage, ChatRoom.

### Phase 4 — Code Review & Comments (COMPLETED)

Added detailed comments to:
- `src/services/MatchingEngineService.ts` — normalization formula reference (whitepaper §3.3)
- `src/services/EmbeddingService.ts` — Gemini embedding model + cost note
- `src/controllers/feedbackController.ts` — weight recalibration table (whitepaper §3.5)
- `src/controllers/goalController.ts` — achievement auto-creation trigger logic
- `src/controllers/analyticsController.ts` — getComparisonData placeholder marker
- `client/src/hooks/useUser.ts` — two-step auth flow explanation
- `client/src/features/auth/PrivateRoute.tsx` — onboarding guard logic

---

## Full Development Roadmap

### Steps 1–9 (Completed by Gemini)

1. General infrastructure, README, initial compilation fixes
2. Goal Tree visualization and editing (add/update/delete nodes, progress sliders, weight sliders)
3. User profile enhancements (avatar upload, name/bio edit via Supabase Storage)
4. Dashboard with community achievements (upvote/downvote/comment)
5. Stripe payment integration (Checkout, webhooks, is_premium gate)
6. Code commenting and documentation
7. GoalTreeComponent with Framer Motion expand/collapse
8. AI Coaching integration (Gemini generative model, premium-gated)
9. Advanced Analytics endpoints (premium-gated, placeholder comparison data)

---

### Step 10 — Goal-Focused Match Chat (HIGH PRIORITY)

**Goal:** When S_AB exceeds threshold, show "Start Collaboration" button. Opens dedicated ChatRoom pre-populated with shared goal context. Chat is scoped to a specific goalNodeId.

**Tasks:**
- [ ] Add `goal_node_id` column to `messages` Supabase table (see manual_actions.txt)
- [ ] Add "Start Collaboration" button to MatchesPage match cards (visible when score > 0.6)
- [ ] Pass `goalNodeId` as query param when navigating to ChatRoom
- [ ] ChatRoom: read `goalNodeId` from URL, show goal context banner at top
- [ ] Backend messageController: store `goalNodeId` in messages row
- [ ] ChatPage: list active collaborations grouped by goal

**Files:** `src/controllers/messageController.ts`, `client/src/features/chat/ChatRoom.tsx`, `client/src/features/matches/MatchesPage.tsx`

---

### Step 11 — Mutual Grading UI (HIGH PRIORITY)

**Goal:** After a chat session, prompt both users to grade each other's goal engagement. Backend auto-recalibrates weights when both parties submit.

**Tasks:**
- [ ] Frontend: trigger feedback dialog on chat close or after 15+ messages
- [ ] Feedback dialog: 8 grade options (FeedbackGrade enum) + optional comment
- [ ] Auto-fill goalNodeId from chat's shared goal context (Step 10)
- [ ] Backend: check if mutual feedback submitted; trigger weight recalibration for both
- [ ] Show "Waiting for partner's feedback" state

**Files:** `client/src/features/chat/ChatRoom.tsx`, `src/controllers/feedbackController.ts`

---

### Step 12 — Guided Onboarding Interest Tree (HIGH PRIORITY)

**Goal:** Replace InitialGoalSetup.tsx stub with multi-step domain selection flow. Free users limited to 3 primary selections.

**Tasks:**
- [ ] Multi-step wizard: Step 1 = choose domains (1–9), Step 2 = set sub-goals per domain, Step 3 = set initial progress/weight
- [ ] Domain selection UI: large cards for each of the 9 life domains with icons
- [ ] Sub-goal suggestions: pre-populated templates per domain
- [ ] Free tier: disable 4th+ domain selection with upgrade prompt
- [ ] On complete: POST /goals to create initial GoalTree, mark onboarding_completed = true
- [ ] PrivateRoute: redirect to /onboarding if !profile.onboarding_completed

**Files:** `client/src/features/onboarding/OnboardingPage.tsx`, `client/src/features/onboarding/components/InitialGoalSetup.tsx`

---

### Step 13 — Progress Streaks (MEDIUM PRIORITY)

**Goal:** Track daily activity. Display streak counter in Dashboard with animated flame icon.

**Tasks:**
- [ ] Supabase: add `last_activity_date DATE` and `current_streak INT DEFAULT 0` to profiles
- [ ] Backend streak helper: called on any goal update. Increment if last_activity was yesterday, reset if > 1 day ago
- [ ] Frontend Dashboard: animated streak counter with flame icon in welcome banner

**Files:** `src/controllers/goalController.ts`, `client/src/features/dashboard/DashboardPage.tsx`

---

### Step 14 — Community Challenges (MEDIUM PRIORITY)

**Goal:** Shared goal events multiple users can join, creating accountability groups.

**Tasks:**
- [ ] New Supabase table: `challenges { id, title, domain, deadline, created_by, participant_ids[] }`
- [ ] New backend routes: POST /challenges, GET /challenges, POST /challenges/:id/join
- [ ] Dashboard section: "Active Challenges" card
- [ ] Join challenge: auto-creates group ChatRoom for participants
- [ ] Challenge completion: system achievement for all finishers

**Files:** New `src/controllers/challengeController.ts`, `src/routes/challengeRoutes.ts`, `src/index.ts`, dashboard

---

### Step 15 — Goal Tree Evolution History (MEDIUM PRIORITY)

**Goal:** Store goal tree snapshots over time. "Your Journey" view with timeline.

**Tasks:**
- [ ] New Supabase table: `goal_tree_snapshots { id, user_id, snapshot JSONB, created_at }`
- [ ] Backend: createOrUpdateGoalTree saves snapshot on every update
- [ ] Analytics endpoint: GET /analytics/tree-evolution/:userId
- [ ] Frontend AnalyticsPage: timeline showing weight/progress changes per domain
- [ ] "Rewind" view: select a past date to see goal tree state (read-only)

**Files:** `src/controllers/goalController.ts`, `src/controllers/analyticsController.ts`, `client/src/features/analytics/AnalyticsPage.tsx`

---

## Architectural Notes

- **Auth flow:** Frontend uses anon Supabase client (JWT in browser). Backend API endpoints needing auth use `authenticateToken` middleware with service-role Supabase client to verify JWT.
- **Gemini Embeddings cost:** Each `getEmbedding()` call = 1 Gemini API request. MatchingEngine calls O(|A.nodes| * |B.nodes|) times per user pair. Cache in Redis or DB for production.
- **Goal weight normalization (whitepaper §3.3):** S_AB = sum(sim_ij * w_i * w_j) / sum(w_i * w_j) over same-domain node pairs.
- **Weight recalibration multipliers (whitepaper §3.5):** SUCCEEDED=×0.8, DISTRACTED=×1.2, LEARNED=×0.9, ADAPTED=×1.05, NOT_APPLICABLE=×1.0
- **Free tier limits:** Max 3 root goals. AI Coaching, Advanced Analytics, unlimited goals = premium only.
- **Supabase RLS:** All tables should have RLS enabled. Backend uses service-role key (bypasses RLS). Frontend anon key is subject to RLS.

---

## Environment Variables Checklist

### Backend (`/.env`)
- [x] STRIPE_SECRET_KEY
- [ ] SUPABASE_URL
- [ ] SUPABASE_SERVICE_ROLE_KEY
- [ ] GEMINI_API_KEY
- [ ] CLIENT_URL
- [ ] STRIPE_PRICE_ID
- [ ] STRIPE_WEBHOOK_SECRET

### Frontend (`/client/.env`)
- [x] REACT_APP_SUPABASE_URL
- [x] REACT_APP_SUPABASE_ANON_KEY
- [x] REACT_APP_STRIPE_PUBLISHABLE_KEY

See `manual_actions.txt` for full setup instructions.
