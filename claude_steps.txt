Hi Claude. You are building Praxis, as outlined in the whitepaper PDF. This file serves as your memory and development log across sessions. Modify it to set goals, track progress, record architectural decisions, and note anything useful.
You can delegate tasks to gemini. Remember to git commit and edit this file at the end of each session.
Never modify this paragraph.
---

## Project Health (as of Session 27 ‚Äî 2026-02-23)

- **Backend TypeScript:** ‚úÖ 0 errors (`npx tsc --noEmit`)
- **Frontend TypeScript:** ‚úÖ 0 errors (`npx tsc --noEmit` from `client/`)
- **Backend Startup:** ‚úÖ Starts cleanly on port 3001 with Express type augmentation.
- **Frontend Startup:** ‚úÖ Compiles and runs on port 3000.
- **Git Status:** `main` ‚Äî commits ahead of origin, pending push (SSH authorization verify needed).
- **Deployment:** ‚ùå Pending (Railway/Vercel ‚Äî see `manual_actions.txt` Steps 11‚Äì12).

---

## SSH Key (Development Machine)

**Machine:** /home/gio (Linux dev box)
**Public key (`~/.ssh/id_ed25519.pub`):**
  ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIO1eduMBO+0sGWDfXeqJ51/F2ElVuOEz7HNCTUU6bObY pezzingiovanniantonio@gmail.com

**GitHub Remote:** git@github.com:ilPez00/praxis_webapp.git
**Status:** Authorized, but ensure agent is running if push fails.

---

## Completed Features Summary

- **Core Infrastructure:** Express backend, Supabase Auth/DB, central error handling, Winston logging.
- **Goal Trees:** Hierarchical CRUD, visualization with Framer Motion, achievement auto-creation.
- **Matching Engine:** Semantic similarity using Gemini embeddings + pgvector (fallback to domain-overlap).
- **Social & Accountability:** Real-time chat (Supabase), Group chats, Media DMs, Video calls (WebRTC), Peer verification protocol, Peer feedback/weight recalibration.
- **Monetization:** Stripe Checkout + Webhook flow for Premium gating.
- **AI & Analytics:** Gemini-powered Coaching, Advanced Analytics (premium-gated).
- **Android App:** Ported core screens (Compose), full networking layer (Retrofit/OkHttp), MVVM architecture.

---

## Recent Development (Sessions 24‚Äì29)

### Session 29 (2026-02-24) ‚Äî Null-Safety & Blank Page Fixes (Claude)

**Root causes found and fixed (4 commits: 446a9f1, 23eff4a, fa0cdad):**

1. **`REACT_APP_API_URL` wrong in `client/.env`** ‚Äî was missing `/api` suffix ‚Üí all API calls hit wrong endpoint ‚Üí fixed to `https://web-production-646a4.up.railway.app/api`. NOTE: gitignored, must also set in Vercel dashboard.
2. **`tsconfig.json`** ‚Äî `api/index.ts` was outside `rootDir: ./src` but not excluded ‚Üí TS compile error ‚Üí added `api` to exclude list.
3. **DashboardPage** ‚Äî `Array.isArray()` guards on achievements, rootNodes, nodes, challenges ‚Üí fixed "e.map is not a function" crash.
4. **GoalTreePage** ‚Äî `supabase.auth.getUser()` was outside the try/finally ‚Üí if it threw, `loading` stayed `true` forever ‚Üí moved inside single try/catch/finally.
5. **GroupsPage** ‚Äî `fetchRooms` depended on `useUser()` resolving (2 Supabase round-trips). Replaced with direct `supabase.auth.getUser()` (fast JWT check). Also added `Array.isArray` guard on joinedRes.value.data.
6. **groupController.ts** ‚Äî missing-table check only matched 'schema cache'/'not found' but not Postgres error code `42P01` / 'does not exist' ‚Üí broadened to catch all schema-missing cases gracefully.
7. **ChatRoom.tsx** ‚Äî `userGoalTree.nodes` and `receiverGoalTree.rootNodes` can be null in DB ‚Üí render-time `.map()`/`.join()`/`.find()` on null values crashed React ‚Üí blank page. Fixed with `?? []` and `Array.isArray` guards on all 5 crash sites.

**Outstanding (from debug.txt ‚Äî Gemini's analysis):**
- Domain enum mismatch: `types/goal.ts` uses 'Investing', 'Culture, Hobbies & Creative Pursuits', 'Intimacy & Romantic Exploration', 'Friendship & Social Engagement' while `models/Domain.ts` uses different strings with `/` separators. Stored goal data uses models/ values; DOMAIN_COLORS keys use types/ values ‚Üí wrong/gray colors in visualizations. Non-critical crash-wise.
- MUI v7 confirmed (^7.3.8) ‚Üí `<Grid size={{ xs: N }}>` syntax is correct, NOT an issue.
- Onboarding guard (`onboarding_completed === false`) could redirect all protected routes silently ‚Äî verify user's `profiles.onboarding_completed` value in Supabase.

**Pending user actions:**
- Set `REACT_APP_API_URL=https://web-production-646a4.up.railway.app/api` in Vercel dashboard env vars
- Hard refresh browser after Vercel redeploys (Ctrl+Shift+R)
- Check Supabase: `SELECT onboarding_completed, goal_tree_edit_count FROM profiles WHERE id = '<your-id>';`
- Reset edit count if needed: `UPDATE profiles SET goal_tree_edit_count = 0 WHERE id = '<your-id>';`
- Run SQL migrations 5Q9‚Äì5Q13 for peer verification + group chats + media tables

### Session 28 (2026-02-24) ‚Äî Debug Analysis (Post-Deployment)
- **Investigated Rendering Issues:** Diagnosed why `/goals/` and `/groups` fail on production.
- **Identified Onboarding Guard:** Confirmed `PrivateRoute` redirects un-onboarded users, which may look like a failed render.
- **Null Safety Audit:** Found missing guards for `room.name` and `node.title` that could cause white-screen crashes.
- **Domain Mismatch:** Discovered `Domain` enum definitions in `types/goal.ts` and `models/Domain.ts` have conflicting string values, causing UI inconsistencies and potential lookup failures.
- **Grid Syntax Check:** Noted use of `size` prop on standard `Grid` which may require migration to `Grid2` for stability.

### Session 27 (2026-02-23) ‚Äî Debug Pass
- **Fixed Dashboard Crashes:** Added guards for non-array match results and null goal domains.
- **Navigation Fixes:** Dashboard "Core Objectives" edit icon now correctly links to `/goal-selection`.
- **GoalTreePage:** Added "Edit Goals" button to header for easier access to edit mode.
- **GroupsPage:** Replaced `Promise.all` with `Promise.allSettled` to prevent one failed fetch from blocking the whole page.
- **Profile Robustness:** Separated avatar upload from profile field saving; name/bio saves now work even if the 'avatars' bucket is missing.

### Session 25 (2026-02-21) ‚Äî Features & Android Networking
- **Community Challenges:** Implemented backend (list, join, leave) and integrated into Dashboard.
- **Identity Verification:** Added `POST /users/:id/verify` endpoint.
- **Android Networking:** Added full Retrofit layer, API models, and repository mapping for real backend communication.

### Session 24 (2026-02-21) ‚Äî Deployment Prep
- **Railway/Vercel Prep:** Added `/health` endpoint and deployment configs (`vercel.json`, `railway.toml`).
- **Onboarding:** Fixed `POST /users/complete-onboarding` flow and enforced re-edit gates.
- **Supabase Overhaul:** Created `migrations/setup.sql` for idempotent table setup.

---

## Active Roadmap

### üî¥ CRITICAL ‚Äî Deployment & Production Setup
- [ ] **Database Migration:** Run `migrations/setup.sql` in Supabase SQL Editor.
- [ ] **Storage Setup:** Create "avatars" and "chat-media" buckets in Supabase (Public: ON).
- [ ] **Backend Deploy:** Connect repo to Railway, set env vars, bind `$PORT`.
- [ ] **Frontend Deploy:** Connect `client/` to Vercel, set `REACT_APP_API_URL` to Railway URL.
- [ ] **Stripe Prod:** Set `STRIPE_PRICE_ID` and register production webhooks.

### üü† HIGH PRIORITY ‚Äî UX & Stability
- [ ] **Seed Demo Users:** Run `POST /admin/seed-demo-users` (needs `ADMIN_SECRET`) to populate Match feed.
- [ ] **Chat Real-time Verification:** Smoke test full DM/Group chat flow in production environment.
- [ ] **Android Sync:** Finalize Firebase ‚Üí Supabase session exchange for real auth on Android.

### üü° MEDIUM PRIORITY ‚Äî Retention & Economy
- [ ] **Streaks:** Verify `current_streak` updates on goal saves in production.
- [ ] **Praxis Points:** Award points for challenge completion and approved verifications.
- [ ] **Push Notifications:** Wire FCM tokens for Android notifications on matches/messages.

---

## Environment Variables Reference

### Backend (`/.env`)
- `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` (MUST be service_role)
- `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `STRIPE_PRICE_ID`
- `GEMINI_API_KEY` (for embeddings/coaching)
- `CLIENT_URL`, `ADMIN_SECRET`, `PORT`

### Frontend (`client/.env`)
- `REACT_APP_SUPABASE_URL`, `REACT_APP_SUPABASE_ANON_KEY`
- `REACT_APP_STRIPE_PUBLISHABLE_KEY`
- `REACT_APP_API_URL` (Point to local 3001 or Railway URL)

---

## Architectural Notes

- **Weight Recalibration:** (¬ß3.5 whitepaper) Recalibrates goal node weights based on peer feedback (SUCCEEDED=0.8, DISTRACTED=1.2, etc.).
- **Matching Algorithm:** (¬ß3.3 whitepaper) Semantic similarity calculation: S_AB = Œ£(sim_ij √ó w_i √ó w_j) / Œ£(w_i √ó w_j).
- **Free Tier Limits:** Enforced 3-root-goal limit and one-time free re-edit gate (premium-gated thereafter).
- **Auth:** Frontend uses Supabase JWT; Backend verifies via `authenticateToken` middleware using service-role key.
