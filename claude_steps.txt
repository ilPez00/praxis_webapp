Hi Claude. You are building Praxis, as outlined in the whitepaper PDF. This file serves as your memory and development log across sessions. Modify it to set goals, track progress, record architectural decisions, and note anything useful.
You can delegate tasks to gemini. Remember to git commit and edit this file at the end of each session.
Never modify this paragraph.
---

## Project Health (as of Session 31 â€” 2026-02-27)

- **Backend TypeScript:** âœ… 0 errors (`npx tsc --noEmit`)
- **Frontend TypeScript:** âœ… 0 errors (`npx tsc --noEmit` from `client/`)
- **Backend Startup:** âœ… Starts cleanly on port 3001 with Express type augmentation.
- **Frontend Startup:** âœ… Compiles and runs on port 3000.
- **Railway Backend:** âœ… All endpoints confirmed working via curl (POST /api/groups, /api/goals, /api/posts â†’ 2xx).
- **Git Status:** `main` â€” up to date with origin (commit `1b07334`).
- **Deployment:** âœ… WORKING â€” groups, goals, posts all functional in production.

---

## SSH Key (Development Machine)

**Machine:** /home/gio (Linux dev box)
**Public key (`~/.ssh/id_ed25519.pub`):**
  ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIO1eduMBO+0sGWDfXeqJ51/F2ElVuOEz7HNCTUU6bObY pezzingiovanniantonio@gmail.com

**GitHub Remote:** git@github.com:ilPez00/praxis_webapp.git
**Status:** Authorized, but ensure agent is running if push fails.

---

## Completed Features Summary

- **Core Infrastructure:** Express backend, Supabase Auth/DB, central error handling, Winston logging.
- **Goal Trees:** Hierarchical CRUD, visualization with Framer Motion, achievement auto-creation.
- **Matching Engine:** Semantic similarity using Gemini embeddings + pgvector (fallback to domain-overlap).
- **Social & Accountability:** Real-time chat (Supabase), Group chats, Media DMs, Video calls (WebRTC), Peer verification protocol, Peer feedback/weight recalibration.
- **Monetization:** Stripe Checkout + Webhook flow for Premium gating.
- **AI & Analytics:** Gemini-powered Coaching, Advanced Analytics (premium-gated).
- **Android App:** Ported core screens (Compose), full networking layer (Retrofit/OkHttp), MVVM architecture.

---

## Recent Development (Sessions 24â€“31)

### Session 31 (2026-02-27) â€” Vercel Routing: Definitive Proxy Fix

**Root Cause (final diagnosis):**
The frontend bundle falls back to `${window.location.origin}/api` when `REACT_APP_API_URL` is empty at build time â€” meaning all API calls go to the Vercel domain, not Railway directly. Every previous routing attempt failed because:
1. `rewrites` with `/(.*) â†’ /index.html` runs AFTER serverless functions but also AFTER static files â€” Vercel was serving `index.html` for GET and returning 405 for POST (can't POST to a static file).
2. `routes` with `dest: "/api$1"` pointed back to the local `api/[...slug].ts` serverless function, which ran Express in a cold-start serverless environment with inconsistent behavior.
3. Even with a proxy `rewrite` to Railway, `api/[...slug].ts` still existed â†’ Vercel matched the serverless function BEFORE evaluating rewrites, so the proxy never ran.

**Confirmed working (curl):** Railway backend handles all methods correctly â€” `POST /api/groups`, `POST /api/goals`, `POST /api/posts` all return 2xx with real UUIDs.

**Fixes Applied (commits `08dee38`, `6a01e88`):**

1. **`vercel.json`** â€” switched to proxy `rewrites`:
   ```json
   "rewrites": [
     { "source": "/api/:path*", "destination": "https://web-production-646a4.up.railway.app/api/:path*" },
     { "source": "/(.*)", "destination": "/index.html" }
   ]
   ```
   `headers` block handles static asset caching separately. This makes Vercel a transparent reverse proxy â€” no env var needed in the frontend bundle.

2. **Deleted `api/[...slug].ts` and `api/index.ts`** â€” removed all Vercel serverless functions. Without them, no function can intercept `/api/*` before the proxy rewrite runs.

3. **`client/src/features/chat/ChatRoom.tsx` line 139** â€” guarded `setMessages` against non-array:
   ```typescript
   // Before: setMessages(response.data || []);
   setMessages(Array.isArray(response.data) ? response.data : []);
   ```
   Prevents `I.map is not a function` crash if API returns unexpected data.

**Architecture going forward:**
- Vercel serves only the static React build + proxies `/api/*` to Railway.
- `REACT_APP_API_URL` env var is no longer needed (can be removed from Vercel dashboard if set).
- Railway remains the sole Express runtime.

**Final fix (commit `1b07334`) â€” the actual root cause:**
The real problem was never Vercel routing. `client/src/lib/api.ts` had a production fallback of `${window.location.origin}/api` â€” so when `REACT_APP_API_URL` wasn't baked into the bundle, every API call hit Vercel (which served `index.html` for GET and 405 for POST). Fix: replaced the fallback with `'https://web-production-646a4.up.railway.app/api'` hardcoded. Frontend now always calls Railway directly in production. **Confirmed working by user.**

---

### Session 30 (2026-02-24) â€” Domain Unification & Meta-data Centralization (Gemini)

**Resolved Domain Inconsistencies & Crashes (6 files updated):**

1.  **`client/src/types/goal.ts` â€” Source of Truth:**
    *   Eliminated the local `Domain` enum duplicate. Now imports/re-exports from `client/src/models/Domain.ts` to ensure the long-form strings (e.g., `'Investing / Financial Growth'`) are used everywhere.
    *   Standardized `DOMAIN_COLORS` with vibrant, consistent hex codes and unified keys.
    *   Added a centralized `DOMAIN_ICONS` map for application-wide iconography.
2.  **Centralized Component Refactoring:**
    *   Removed redundant `DOMAIN_COLORS` (and `DOMAIN_ICONS`) definitions from:
        *   `DashboardPage.tsx`
        *   `MatchesPage.tsx` (also replaced `domainColor` helper with direct `DOMAIN_COLORS` lookup)
        *   `OnboardingPage.tsx`
        *   `AnalyticsPage.tsx`
        *   `GoalNodeDisplay.tsx`
        *   `GoalSelectionPage.tsx`
    *   All components now import these constants from `types/goal.ts`, ensuring 100% visual and logical alignment.
3.  **Crash Fix Verification:**
    *   Verified the "Failed to save goals" crash in `GoalSelectionPage.tsx`. The fix `(existingTree?.nodes || []).filter(...)` is present in the worktree, preventing the `TypeError` on `undefined` for new users.

**Outstanding (from debug.txt):**
- MUI Grid syntax: Some components use `size` prop on `Grid` (v1). While `@mui/material` is at `^7.3.8`, this is likely stable, but monitoring for layout issues is advised.
- Database: Verify SQL migrations 5Q9â€“5Q13 are run for social features.

**Pending user actions:**
- Set `REACT_APP_API_URL=https://web-production-646a4.up.railway.app/api` in Vercel dashboard.
- Run `ALTER TABLE` queries for missing `profiles` columns (name, bio, etc.) if not already done.


### Session 29 (2026-02-27) â€” 405 + 500 Root Cause & Fix

**Root Causes Diagnosed:**
1. **405 on all POST/PUT/DELETE (Vercel)**: Vercel's rewrite `destination: "/api?_vp=:path*"` does NOT set `req.url` to the rewritten URL inside the function â€” `req.url` is always `/api`. Express 5 returns 405 because only `apiRouter.get('/')` exists at that path.
2. **500 on all write operations (Railway)**: `SUPABASE_SERVICE_ROLE_KEY` on Railway is set to the publishable/anon key (`sb_publishable_...`). RLS blocks INSERT/UPDATE; SELECT works because anon policies allow reads.

**Code Fixes Applied:**
- `api/[...slug].ts` â€” new catch-all Vercel function. File-system routing preserves `req.url` as full path (`/api/groups`, `/api/posts`). No URL manipulation needed.
- `api/index.ts` â€” simplified to just `export default app` (handles only `/api` root)
- `vercel.json` â€” removed `/api/:path*` rewrite; kept only `/(.*) â†’ /index.html` for React Router

**Manual Fixes Required (user must do):**
- **Railway dashboard**: Set `SUPABASE_SERVICE_ROLE_KEY` to the SERVICE ROLE JWT (`eyJhbGci...` long key from Supabase > Settings > API > service_role). NOT the publishable key.
- **Vercel dashboard**: Delete or correct `REACT_APP_API_URL` (must be `https://web-production-646a4.up.railway.app/api`, no trailing slash). `client/.env` is git-tracked but Vercel dashboard env vars override it.

### Session 28 (2026-02-24) â€” Debug Analysis (Post-Deployment)
- **Investigated Rendering Issues:** Diagnosed why `/goals/` and `/groups` fail on production.
- **Identified Onboarding Guard:** Confirmed `PrivateRoute` redirects un-onboarded users, which may look like a failed render.
- **Null Safety Audit:** Found missing guards for `room.name` and `node.title` that could cause white-screen crashes.
- **Domain Mismatch:** Discovered `Domain` enum definitions in `types/goal.ts` and `models/Domain.ts` have conflicting string values, causing UI inconsistencies and potential lookup failures.
- **Grid Syntax Check:** Noted use of `size` prop on standard `Grid` which may require migration to `Grid2` for stability.

### Session 27 (2026-02-23) â€” Debug Pass
- **Fixed Dashboard Crashes:** Added guards for non-array match results and null goal domains.
- **Navigation Fixes:** Dashboard "Core Objectives" edit icon now correctly links to `/goal-selection`.
- **GoalTreePage:** Added "Edit Goals" button to header for easier access to edit mode.
- **GroupsPage:** Replaced `Promise.all` with `Promise.allSettled` to prevent one failed fetch from blocking the whole page.
- **Profile Robustness:** Separated avatar upload from profile field saving; name/bio saves now work even if the 'avatars' bucket is missing.

### Session 25 (2026-02-21) â€” Features & Android Networking
- **Community Challenges:** Implemented backend (list, join, leave) and integrated into Dashboard.
- **Identity Verification:** Added `POST /users/:id/verify` endpoint.
- **Android Networking:** Added full Retrofit layer, API models, and repository mapping for real backend communication.

### Session 24 (2026-02-21) â€” Deployment Prep
- **Railway/Vercel Prep:** Added `/health` endpoint and deployment configs (`vercel.json`, `railway.toml`).
- **Onboarding:** Fixed `POST /users/complete-onboarding` flow and enforced re-edit gates.
- **Supabase Overhaul:** Created `migrations/setup.sql` for idempotent table setup.

---

### Session 32 (2026-03-01) â€” Goal Metadata + Reddit-Style Groups

**Goal fields (mandatory description + metrics):**
- `client/src/types/goal.ts`: Added `completionMetric?` and `targetDate?` to `GoalNode` interface.
- `client/src/features/goals/GoalSelectionPage.tsx`:
  - `SelectedGoal` interface: renamed `details` â†’ `description` (required), added `completionMetric` (required), `targetDate` (optional date).
  - Compose UI: "Description *" + "Success Metric *" (both required, show inline error when empty) + "Target Date" date picker.
  - `handleSave`: validation gate â€” toasts error if any goal is missing description or completionMetric.
  - New fields stored in JSONB node payload (`completionMetric`, `targetDate`). `customDetails` carries `description`.
  - Existing tree load: maps `node.completionMetric` and `node.targetDate` back into edit form.

**Groups â†’ Reddit-style topic boards:**
- `client/src/features/groups/GroupChatRoom.tsx`: Full rewrite as `GroupBoard`.
  - Tab 0 "Posts": `<PostFeed context={roomId} isBoard />` â€” shows room description banner then post feed.
  - Tab 1 "Chat": original real-time group chat UI (unchanged logic).
  - Header shows member count inline.
- `client/src/features/posts/PostFeed.tsx`:
  - Added `isBoard?: boolean` prop; `context` type widened from union to `string`.
  - In board mode: compose shows "Title *" field (required) above body; "Submit" replaces "Post".
  - `Post` interface: added `title: string | null`.
  - Post card: renders `post.title` as bold heading above body text when present.
- `src/controllers/postController.ts`:
  - `createPost`: accepts `title` in body, stores in DB.
  - `getPosts`: explicit column select now includes `title`.
- `migrations/setup.sql`: Added `ALTER TABLE public.posts ADD COLUMN IF NOT EXISTS title TEXT;`.

**Manual action required:** Run `migrations/setup.sql` (or just the ALTER TABLE line) in Supabase SQL Editor to add the `title` column to the `posts` table.

---

## Active Roadmap

### ðŸ”´ CRITICAL â€” Deployment & Production Setup
- [ ] **Database Migration:** Run `migrations/setup.sql` in Supabase SQL Editor.
- [ ] **Storage Setup:** Create "avatars" and "chat-media" buckets in Supabase (Public: ON).
- [x] **Backend Deploy:** Railway running â€” all endpoints confirmed via curl.
- [x] **Frontend Deploy:** Vercel deployed â€” `api.ts` hardcodes Railway URL as production fallback.
- [x] **Smoke Test:** Groups, posts, goals confirmed working in production by user.
- [ ] **Stripe Prod:** Set `STRIPE_PRICE_ID` and register production webhooks.

### ðŸŸ  HIGH PRIORITY â€” UX & Stability
- [ ] **Seed Demo Users:** Run `POST /admin/seed-demo-users` (needs `ADMIN_SECRET`) to populate Match feed.
- [ ] **Chat Real-time Verification:** Smoke test full DM/Group chat flow in production environment.
- [ ] **Android Sync:** Finalize Firebase â†’ Supabase session exchange for real auth on Android.

### ðŸŸ¡ MEDIUM PRIORITY â€” Retention & Economy
- [ ] **Streaks:** Verify `current_streak` updates on goal saves in production.
- [ ] **Praxis Points:** Award points for challenge completion and approved verifications.
- [ ] **Push Notifications:** Wire FCM tokens for Android notifications on matches/messages.

---

## Environment Variables Reference

### Backend (`/.env`)
- `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` (MUST be service_role)
- `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `STRIPE_PRICE_ID`
- `GEMINI_API_KEY` (for embeddings/coaching)
- `CLIENT_URL`, `ADMIN_SECRET`, `PORT`

### Frontend (`client/.env`)
- `REACT_APP_SUPABASE_URL`, `REACT_APP_SUPABASE_ANON_KEY`
- `REACT_APP_STRIPE_PUBLISHABLE_KEY`
- `REACT_APP_API_URL` (Point to local 3001 or Railway URL)

---

## Architectural Notes

- **Weight Recalibration:** (Â§3.5 whitepaper) Recalibrates goal node weights based on peer feedback (SUCCEEDED=0.8, DISTRACTED=1.2, etc.).
- **Matching Algorithm:** (Â§3.3 whitepaper) Semantic similarity calculation: S_AB = Î£(sim_ij Ã— w_i Ã— w_j) / Î£(w_i Ã— w_j).
- **Free Tier Limits:** Enforced 3-root-goal limit and one-time free re-edit gate (premium-gated thereafter).
- **Auth:** Frontend uses Supabase JWT; Backend verifies via `authenticateToken` middleware using service-role key.
