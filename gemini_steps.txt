Hi gemini. you are building praxis, as outlined in the whitepaper pdf. This file will serve as your memory for further developement between sessions. feel free to modify it to set goals, keep notes, track progress, and whatever you see fit. thank you.my 

**Completed Development Plan:**

1.  **Goal Tree Visualization and Editing Page:** (COMPLETED)
    *   Enhanced `GoalTreePage.tsx` to allow users to visualize and edit their goal trees, including adding, updating, and deleting goal nodes.
    *   `GoalNodeDisplay.tsx` and `GoalTreeDisplay.tsx` updated for proper interaction.
    *   Implemented UI for adding new goal nodes to a tree.
    *   Implemented UI for editing existing goal node details (name, description, custom details, category, progress, weight).
    *   Implemented UI for deleting goal nodes with confirmation and recursive deletion of sub-goals.
    *   Backend API (via `POST /goals`) handles these goal tree editing operations.

2.  **User Profile Enhancements:** (COMPLETED)
    *   Allowed users to edit their profile picture, name, age, and bio.
    *   Implemented profile picture upload functionality to Supabase storage.
    *   `ProfilePage.tsx` updated with file input for avatar and logic for handling image upload to Supabase and updating the user's `avatar_url`.
    *   Ensured UI for editing name, age, and bio on `ProfilePage` is functional and correctly updates the backend via `axios.put` to `/users/:id`.

3.  **Dashboard with Achievements:** (COMPLETED)
    *   Displayed a list of other users' achievements on the `DashboardPage.tsx` with functionality to upvote, downvote, and comment.
    *   Created client-side models (`client/src/models/Achievement.ts`, `AchievementComment.ts`, `AchievementVote.ts`).
    *   Provided SQL definitions for `achievements`, `achievement_comments`, and `achievement_votes` Supabase tables, including RLS and vote count triggers.
    *   Implemented backend API endpoints in `src/controllers/achievementController.ts` and `src/routes/achievementRoutes.ts` for:
        *   Creating achievements.
        *   Retrieving a list of achievements.
        *   Upvoting/downvoting an achievement (with unique user vote enforcement).
        *   Adding and retrieving comments for an achievement.
    *   Implemented frontend UI on `DashboardPage.tsx` to:
        *   Fetch and display achievements.
        *   Show achievement `totalUpvotes` and `totalDownvotes`.
        *   Display user avatars (with fallback to initials) for achievements and comments.
        *   Provide buttons for upvoting and downvoting with `refreshAchievements` callback.
        *   Implement a dialog to display and add comments with `refreshAchievements` callback.

4.  **Stripe Payment System Integration:** (COMPLETED)
    *   **Stripe SDKs:** Installed `stripe` Node.js library in the backend and `@stripe/stripe-js`, `@stripe/react-stripe-js` in the frontend.
    *   **Stripe Configuration:** Set up Stripe environment variables (`STRIPE_SECRET_KEY`, `STRIPE_PUBLISHABLE_KEY`, `STRIPE_PRODUCT_ID`, `STRIPE_PRICE_ID`) and `dotenv` in the backend. `REACT_APP_STRIPE_PUBLISHABLE_KEY` added to frontend `.env`.
    *   **Backend Checkout API:** Implemented backend API endpoint (`POST /stripe/create-checkout-session`) for creating Stripe Checkout Sessions.
    *   **Supabase `user_subscriptions` Table:** Created and configured `user_subscriptions` table in Supabase, along with modifying `profiles` table to include `is_premium` and adding triggers to automatically manage premium status based on subscription events.
    *   **Backend Webhook Handler:** Implemented backend webhook handler (`POST /stripe/webhook`) for Stripe events (`checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted`) to securely update Supabase.
    *   **Frontend Checkout UI:** Implemented frontend UI to initiate Stripe Checkout via `UpgradePage.tsx` and created `SuccessPage.tsx` and `CancelPage.tsx` for redirect handling.
    *   **Frontend Conditional UI:** Implemented conditional UI for premium features on `DashboardPage.tsx`, displaying an "Upgrade Now" button if the user is not premium.
    *   **User Model & Hook Update:** Updated `client/src/models/User.ts` with `is_premium` and modified `client/src/hooks/useUser.ts` to fetch this status from Supabase.

**5. Code Commenting:** (COMPLETED)
    *   Added comments to logical blocks in both frontend and backend files, focusing on new features and complex logic introduced during this session.
    *   Commented on `src/controllers/stripeController.ts`, `src/controllers/achievementController.ts`, `src/controllers/goalController.ts`, `src/controllers/userController.ts` in the backend.
    *   Commented on `client/src/pages/UpgradePage.tsx`, `client/src/pages/SuccessPage.tsx`, `client/src/pages/CancelPage.tsx`, `client/src/hooks/useUser.ts`, `client/src/pages/DashboardPage.tsx`, and `client/src/pages/ProfilePage.tsx` in the frontend.

---
**Supabase Table Definitions for Stripe Integration**

**1. `user_subscriptions` Table:**

```sql
CREATE TABLE public.user_subscriptions (
    id text PRIMARY KEY, -- Stripe Subscription ID
    user_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    status text NOT NULL, -- e.g., 'active', 'cancelled', 'past_due', 'trialing'
    current_period_start timestamp with time zone NOT NULL,
    current_period_end timestamp with time zone NOT NULL,
    product_id text NOT NULL, -- Stripe Product ID
    price_id text NOT NULL, -- Stripe Price ID
    customer_id text NOT NULL, -- Stripe Customer ID
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    UNIQUE (user_id) -- A user can only have one active subscription of this type
);

-- RLS for user_subscriptions
ALTER TABLE public.user_subscriptions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own subscriptions." ON public.user_subscriptions FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert their own subscriptions." ON public.user_subscriptions FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own subscriptions." ON public.user_subscriptions FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own subscriptions." ON public.user_subscriptions FOR DELETE USING (auth.uid() = user_id);

-- Trigger to set updated_at on user_subscriptions table (assuming set_updated_at function exists)
CREATE TRIGGER set_user_subscriptions_updated_at
BEFORE UPDATE ON public.user_subscriptions
FOR EACH ROW
EXECUTE FUNCTION public.set_updated_at();

-- You might need to define the set_updated_at function if it's not already in your Supabase project:
/*
CREATE OR REPLACE FUNCTION public.set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
*/
```

**2. `profiles` Table Modification & Trigger:**

```sql
-- Add is_premium column to profiles table
ALTER TABLE public.profiles ADD COLUMN is_premium boolean DEFAULT false NOT NULL;

-- Function to update profiles.is_premium based on user_subscriptions status
CREATE OR REPLACE FUNCTION public.update_profile_premium_status()
RETURNS TRIGGER AS $$
BEGIN
    -- For INSERT or UPDATE on user_subscriptions
    IF (TG_OP = 'INSERT' OR TG_OP = 'UPDATE') THEN
        UPDATE public.profiles
        SET is_premium = (NEW.status = 'active' OR NEW.status = 'trialing')
        WHERE id = NEW.user_id;
    -- For DELETE on user_subscriptions
    ELSIF (TG_OP = 'DELETE') THEN
        -- Check if user has any other active/trialing subscriptions
        IF NOT EXISTS (SELECT 1 FROM public.user_subscriptions WHERE user_id = OLD.user_id AND (status = 'active' OR status = 'trialing')) THEN
            UPDATE public.profiles
            SET is_premium = false
            WHERE id = OLD.user_id;
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for profiles.is_premium status
CREATE TRIGGER user_subscriptions_premium_status_trigger
AFTER INSERT OR UPDATE OR DELETE ON public.user_subscriptions
FOR EACH ROW EXECUTE FUNCTION public.update_profile_premium_status();
```

Please run these SQL commands in your Supabase SQL editor to set up the necessary tables and triggers.
