Hi Claude. You are building Praxis â€” a social platform that matches users based on the semantic
similarity and progress-alignment of their hierarchical goal trees, then enables peer
accountability through real-time chat and mutual grading.

This file is your persistent memory across sessions. Update it every session: mark tasks done,
add new tasks, record decisions, and leave notes for your future self. Treat it as a logbook,
not just a checklist.

The whitepaper is the authoritative product spec. When in doubt, check it.
The companion file `manual_actions.txt` contains all required Supabase/Stripe setup SQL.
Feel free to delegate tasks to gemini-cli, which you can call by running "gemini" 
---

## Project Health (last updated: 2026-02-20 Session 15)

- Backend TypeScript: âœ… 0 errors (`npx tsc --noEmit` from project root)
- Frontend TypeScript: âœ… 0 errors (`npx tsc --noEmit` from `client/`)
- Frontend startup: âœ… Compiles and runs on :3000
- Backend startup: âœ… Starts cleanly with all env vars set (SUPABASE_URL + SUPABASE_PUBLISHABLE_KEY + others)
- ts-node fix: âœ… Added `/// <reference path="./types/express.d.ts" />` to `src/index.ts` so ts-node finds the Express type augmentation
- Git branch: `main` â€” commits ahead of origin, pending push (SSH key not yet authorized on GitHub)
- Deployment: âŒ not yet deployed (Railway + Vercel â€” full steps in manual_actions.txt Steps 11â€“12)

---

## Completed Sessions

### Sessions 1â€“9 â€” Gemini CLI (foundation)

1. Infrastructure, README, initial compilation fixes
2. GoalTree visualization + editing (add/update/delete nodes, progress/weight sliders)
3. Profile enhancements (avatar upload to Supabase Storage, name/bio editing)
4. Dashboard with community achievements (upvote/downvote/comment, Supabase tables + triggers)
5. Stripe payment integration (Checkout, webhooks, `is_premium` gate)
6. Code commenting pass
7. GoalTreeComponent with Framer Motion expand/collapse animations
8. AI Coaching via Gemini generative model (premium-gated)
9. Advanced Analytics endpoints (premium-gated; `getComparisonData` is placeholder)

---

### Session 10 â€” Claude Code (2026-02-19) â€” Full Audit + Styling

**Phase 1 â€” Critical bug fixes:**
- `src/index.ts`: Added 8 missing route imports (server crashed on start)
- `src/middleware/authenticateToken.ts`: Created from scratch (Supabase JWT verification)
- `src/types/express.d.ts`: Extend Express Request with `user?: { id: string }`
- `DashboardPage.tsx`: Fixed missing `commentsLoading` state, wrong `../models` import paths,
  added auth header to AI Coaching axios call
- `AnalyticsPage.tsx`: Added auth headers to all 5 analytics calls; fixed import paths
- `src/utils/appErrors.ts`: Fixed `catchAsync` to use proper `RequestHandler` return type
- `src/controllers/achievementController.ts`: Added null guards after Supabase inserts
- `src/controllers/analyticsController.ts`: Fixed `string | string[]` type cast

**Phase 2 â€” Connect stub pages to real backend:**
- `GoalTreePage.tsx`: Replaced `exampleGoalTreeData` with real `GET /goals/:userId`.
  Added `buildFrontendTree()` to map backend flat nodes â†’ frontend tree
  (nameâ†’title, progress 0-1â†’0-100, parentId flat array â†’ children tree)
- `MatchesPage.tsx`: Replaced mock data + fake scoring with real `GET /matches/:userId`
  + Supabase profile fetch per match

**Phase 3 â€” Styling overhaul:**
- New MUI dark theme: #0A0B14 bg, #F59E0B primary (amber), #8B5CF6 secondary (violet)
- `GlassCard` component: glassmorphism Paper wrapper with `glow` + `glowColor` props
- Full redesigns: Navbar, HomePage, DashboardPage, GoalTreePage, MatchesPage,
  ProfilePage, UpgradePage, AnalyticsPage, LoginPage, SignupPage, ChatRoom

**Phase 4 â€” Comments:** MatchingEngineService, EmbeddingService, feedbackController,
goalController, analyticsController, useUser hook, PrivateRoute

**Phase 5 â€” Docs:** `claude_steps.txt` created, `manual_actions.txt` updated

---

### Session 15 (cont.) â€” Claude Code (2026-02-20) â€” Debug run + SQL migration overhaul

**Bugs found and fixed during debug run:**

1. **`goalController.ts` crash â€” `rootNodes.length` on undefined**
   - Trigger: `POST /goals` without `rootNodes` in body â†’ 500 "Cannot read properties of undefined (reading 'length')"
   - Fix: `const safeRootNodes = rootNodes || []` + use `safeRootNodes` in both limit check and insert/update
   - File: `src/controllers/goalController.ts` lines 123, 190, 219

2. **`errorHandler.ts` â€” 404 routes returning HTTP 500**
   - Trigger: any unmatched route â†’ response body said "Not Found" but HTTP status was 500
   - Root cause: `notFoundHandler` called `next(error)` but the plain `Error` object had no `.statusCode`, so `errorHandler` fell back to 500
   - Fix: set `error.statusCode = 404` before calling `next(error)` in `notFoundHandler`
   - File: `src/middleware/errorHandler.ts`

3. **`messageRoutes.ts` â€” `POST /messages/send` route missing**
   - Trigger: ChatRoom sends messages to `POST /messages/send` â†’ 404 (previously masked as 500)
   - Root cause: backend only had `POST /messages/` (no `/send` suffix) but frontend called `/messages/send`
   - Fix: added `router.post('/send', sendMessage)` alias
   - File: `src/routes/messageRoutes.ts`

**Missing Supabase tables discovered:**
- During API testing, found that `messages`, `completion_requests`, `chat_rooms`, `chat_room_members` do not exist yet in the project database
- These must be created by running the SQL in manual_actions.txt Step 5
- Added detailed WHERE/WHAT/SUCCESS to every SQL step
- QUICK START section now lists all required SQL queries in correct order with feature labels

**`manual_actions.txt` overhaul:**
- Query 4 (messages): Rewritten to include ALL columns from the start (fresh installs get complete schema)
  Old version only had: id, sender_id, receiver_id, content, goal_node_id, timestamp
  New version adds: message_type, media_url, room_id, metadata
- Query 8B: Rewritten as upgrade-only path for users who ran the old Query 4
- Query 9A (completion_requests): Added DROP POLICY IF EXISTS guards for idempotency
- Query 9C (chat_rooms): Added DROP POLICY IF EXISTS guards
- Query 9D (chat_room_members): Added DROP POLICY IF EXISTS guards; added note to run AFTER 9C
- Query 9E (chat-media bucket): Added exact dashboard URL, failure symptom, policy DROP guards
- Query 9F (Realtime): Added alternative SQL approach for enabling publication
- QUICK START: Expanded to 5 steps; lists every required SQL query by feature name
- Checklist updated with â†’ pointers to exact SQL step numbers

**TypeScript after fixes:** âœ… 0 errors backend + 0 errors frontend

---

### Session 15 â€” Claude Code (2026-02-20) â€” Peer verification, media DMs, video calls, group chats

**Peer-verified goal completion:**
- `src/controllers/completionController.ts` (NEW): Three endpoints â€”
  - `POST /completions`: creates `completion_requests` row + sends `message_type='completion_request'` DM to verifier with metadata `{requestId, goalNodeId, goalName}`
  - `PATCH /completions/:id/respond`: verifier approves/rejects â†’ updates `goal_trees.nodes` (progress=1.0 on approve) + sends `message_type='system'` DM with result
  - `GET /completions/pending?userId=xxx`: list pending verifications for a user
- `src/routes/completionRoutes.ts` (NEW): mounted at `/completions` in `src/index.ts`
- `GoalTreeVisualization.tsx`: added `onNodeClick?: (node: GoalNode) => void` prop; click calls it instead of always toggling collapse
- `GoalTreePage.tsx`: full rewrite â€” claim dialog shows DM partners as selectable verifiers; `handleSendClaim()` POSTs to `/completions`; partners fetched from `messages` table
- `GoalTreePage.tsx` fix: `for...of Set<string>` â†’ `for...of Array.from(Set)` (TS target compat)

**Media upload in DMs:**
- `src/controllers/messageController.ts`: extended `sendMessage` to accept `messageType`, `mediaUrl`, `metadata` optional fields
- `ChatRoom.tsx`: attach button (hidden `<input type="file">`) â†’ uploads to Supabase Storage `chat-media` bucket â†’ sends `message_type='image'|'file'` message with `media_url`
- Message rendering: `system` = centered gray italic; `completion_request` = amber card with Verify/Reject buttons (verifier only); `image` = inline `<img>`; `file` = clickable file name; `text` = existing bubble

**Video calls in DMs:**
- `VideoCall.tsx` (NEW): WebRTC peer-to-peer via Supabase Broadcast signaling channel `webrtc_{channelName}`. Flow: receiver sends `call-ready` â†’ initiator creates offer â†’ receiver creates answer â†’ ICE exchange. Mute mic / toggle cam buttons. Full-screen dialog with PiP local video.
- `ChatRoom.tsx`: videocam icon in header â†’ broadcasts `call-invite` + opens VideoCall as initiator. `call-invite` listener shows incoming call Dialog with Accept/Decline. Decline sends `call-declined` broadcast. `call-ended` broadcast closes VideoCall on both sides.

**Group chats:**
- `src/controllers/groupController.ts` (NEW): listRooms, createRoom (auto-joins creator), joinRoom, leaveRoom, getRoomMessages, sendRoomMessage, getRoomMembers, getRoom, getJoinedRooms
- `src/routes/groupRoutes.ts` (NEW): mounted at `/groups` in `src/index.ts` (`/joined` before `/:roomId`)
- `GroupsPage.tsx` (NEW): tabs All Rooms / My Rooms; room cards with domain color, member count, Join/Enter; Create Room dialog with name+desc+domain
- `GroupChatRoom.tsx` (NEW): realtime group chat via Supabase postgres_changes filtered by `room_id`; file uploads; member drawer
- `routes.tsx`: added `/groups` â†’ GroupsPage, `/groups/:roomId` â†’ GroupChatRoom
- `Navbar.tsx`: added Chat + Groups links (desktop inline + mobile drawer)

**Database migrations added to `manual_actions.txt`:**
- Steps 5Q9â€“5Q13: `completion_requests` table (RLS), messages new columns (`message_type`, `media_url`, `room_id`, `metadata`), `chat_rooms` table (RLS), `chat_room_members` table (RLS), Supabase Storage `chat-media` bucket

**TypeScript:** âœ… 0 errors backend + 0 errors frontend

---

### Session 14 cont. â€” Claude Code (2026-02-19) â€” Forced onboarding + one free re-edit gate

**Forced goal tree after login:**
- `OnboardingPage.tsx`: Removed `onboarding_completed: true` from profile update â€” goal tree setup now required before app access
- `GoalSelectionPage.tsx`: After saving goals, calls `supabase.update({ onboarding_completed: true })` then `refetch()` then navigates. Users cannot access the dashboard until they've saved their initial goal tree.

**One free re-edit gate:**
- `manual_actions.txt` (Step 5 Query 5): SQL to add `goal_tree_edit_count INT DEFAULT 0` to profiles
- `goalController.ts`: When updating (not inserting) a goal tree â€” checks `goal_tree_edit_count >= 1 && !isPremium` â†’ 403 ForbiddenError; on success increments the count
- `User.ts` + `useUser.ts`: `goal_tree_edit_count` mapped from profile
- `GoalSelectionPage.tsx`: On mount, if `onboarding_completed === true` (re-edit):
  - `edit_count >= 1 && !premium` â†’ toast.error + redirect to /upgrade
  - `edit_count === 0` â†’ toast warning "1 free edit remaining"
- Edge: graceful degradation if column doesn't exist (treats as 0)

### Session 14 â€” Claude Code (2026-02-19) â€” Run + debug + SHOULD HAVE features

**Debugging & startup fixes:**
- `ChatPage.tsx`: Removed undefined `theme.palette.action.active` ref from Avatar sx â€” fixed TS error
- `src/index.ts`: Added `/// <reference path="./types/express.d.ts" />` â€” ts-node was not discovering the
  global Express Request augmentation, causing `req.user` to error at runtime even though tsc passed
- Both backend (:3001) and frontend (:3000) now start cleanly with the env vars in .env

**ProfilePage â€” public read-only view:**
- Reads `:id` from `useParams`; computes `isOwnProfile = !paramId || paramId === user.id`
- When viewing another user: hides Edit/Save buttons, hides edit form, shows their name in "Goal Tree" card
- Route `/profile/:id` already existed in routes.tsx â€” now actually works

**MatchesPage â€” "View Profile" button on match cards:**
- Added `onViewProfile` prop to `MatchCard`; renders "Profile" outlined button beside "Message"
- Demo profiles: shows toast; real profiles: navigates to `/profile/:userId`

**ChatRoom â€” feedback form auth + UX fixes:**
- `handleSubmitFeedback`: added `Authorization: Bearer ${session?.access_token}` header
- Replaced `alert()` calls with `toast.error()` / `toast.success()`
- Added `submittingFeedback` state; button shows "Submittingâ€¦" and is disabled during request

**GoalTreePage â€” empty-state CTA:**
- Replaced bare Alert("You haven't set any goals yet") with a proper CTA card â†’ `/goal-selection`

**DashboardPage â€” empty-state CTA:**
- Replaced generic "Initialize Tree" link with styled "Set Up My Goals" button â†’ `/goal-selection`

**ESLint cleanup (unused imports removed):**
- `DashboardPage.tsx`: removed ThumbDownIcon, PeopleIcon, EmojiEventsIcon
- `GoalTreePage.tsx`: removed DOMAIN_COLORS (kept Domain), removed useUser (not needed)
- `GoalNodeComponent.tsx`: removed AnimatePresence, Tooltip
- `GoalTreeComponent.tsx`: removed exampleGoalTreeData
- `IdentityVerificationPage.tsx`: removed Stack, renamed `data` â†’ `_` in destructure

### Session 13 â€” Claude Code (2026-02-19) â€” MatchesPage polish + run script + docs

**MatchesPage full rewrite:**
- `client/src/data/mockMatches.ts`: added `overallProgress` field (0-100) to all 7 profiles
- `MatchesPage.tsx`: goal progress bar tease (linear bar with %, color-coded); bio line-clamped
  to 3 lines; demo user Message click â†’ toast + redirect to /goals/:id instead of /chat/demo-X
- Empty state: two CTAs (Build goal tree + Upgrade for more matches)
- Removed unused `IconButton` import and unused `currentUserId` prop from `MatchCard`

**Startup:**
- `run_praxis.sh` created: checks env vars, reports which are missing and why they matter,
  kills stale processes on :3000/:3001, starts backend + frontend with PID tracking,
  writes to .logs/, graceful Ctrl+C cleanup
- Discovered: backend requires `SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY` to start.
  Frontend starts standalone on :3000 (with harmless face-api.js source map warnings,
  now suppressed by `GENERATE_SOURCEMAP=false` in client/.env)

**Docs:**
- `README.md`: complete rewrite â€” what Praxis is, how matching works, current status table,
  quick start, first-run expectations, API routes, env var reference, architecture notes
- `manual_actions.txt`: full idiot-proof rewrite â€” QUICK START section (4 steps to run locally),
  full numbered checklist, every step has WHERE+WHAT+SUCCESS, TROUBLESHOOTING section

**Note:** `gemini_steps.txt` was renamed to `claude` on disk by user; restored.

---

### Session 11 â€” Claude Code (2026-02-19) â€” Private Beta Sprint

**Fix 1 â€” Chat route bug:**
- `routes.tsx`: `/chat/:user1Id/:user2Id` was pointing to `ChatPage` (conversation list)
  instead of `ChatRoom`. Fixed. Removed duplicate `/chat/:id` route.

**Fix 2 â€” Supabase snake_case column names:**
- All chat code used camelCase (`senderId`, `receiverId`) but the `messages` table
  uses snake_case (`sender_id`, `receiver_id`)
- Fixed in: `messageController.ts` (queries + insert), `ChatPage.tsx` (.or() filter,
  field reads), `ChatRoom.tsx` (realtime filter, payload checks, message render)
- Added `msg.timestamp ?? msg.created_at` fallback

**Fix 3 â€” Onboarding guard:**
- `User.ts`: Added `onboarding_completed?: boolean`
- `useUser.ts`: Maps `profile.onboarding_completed` into user object.
  Also refactored to `useCallback`, expose `refetch`, only re-fetch on
  `SIGNED_IN`/`USER_UPDATED` (not every token refresh)
- `PrivateRoute.tsx`: Redirects to `/onboarding` when `onboarding_completed === false`.
  Exempts `/onboarding` and `/goal-selection`. Loading state upgraded to centered
  `CircularProgress`.

**Fix 4 â€” Replace hardcoded `localhost:3001` with env var:**
- Created `client/src/lib/api.ts` exporting `API_URL` constant
  (`REACT_APP_API_URL` env var with `http://localhost:3001` fallback)
- Updated 11 files: all `axios` calls now use template literal `${API_URL}/...`
- Added `REACT_APP_API_URL=http://localhost:3001` to `client/.env`
- `client/.env.example` already had it

**Docs:**
- `README.md`: Full rewrite. Accurate tech stack, directory structure, quick start,
  Supabase SQL setup (copy-paste ready), API route table, env var reference, deployment guide.
- `root/.env.example` created (backend env var template)
- Fixed import paths in 10+ files (GoalNodeComponent, GoalTreeComponent, GoalNodeDisplay,
  GoalTreeDisplay, GoalSelectionPage, IdentityVerificationPage, OnboardingPage, InitialGoalSetup)
- Fixed MUI v7 Grid API (`<Grid item xs={N}>` â†’ `<Grid size={{ xs: N }}>`) across all pages
- Fixed TypeScript arithmetic error in GoalNodeComponent (`theme.spacing(level * 2)`)
- Removed non-existent `Achievement.totalComments` reference in DashboardPage

---

## Environment Variables

### Backend (`/.env`)
- [x] STRIPE_SECRET_KEY
- [ ] SUPABASE_URL
- [ ] SUPABASE_SERVICE_ROLE_KEY
- [ ] GEMINI_API_KEY
- [ ] CLIENT_URL
- [ ] STRIPE_PRICE_ID
- [ ] STRIPE_WEBHOOK_SECRET
- [ ] PORT (defaults to 3001)

### Frontend (`/client/.env`)
- [x] REACT_APP_SUPABASE_URL
- [x] REACT_APP_SUPABASE_ANON_KEY
- [x] REACT_APP_STRIPE_PUBLISHABLE_KEY
- [x] REACT_APP_API_URL

See `.env.example` and `client/.env.example` for templates.
See `manual_actions.txt` for full Supabase + Stripe setup instructions.

---

## Active Roadmap

### ðŸ”´ MUST HAVE â€” Before beta invite goes out

#### Deploy backend to Railway
- [ ] Update `src/index.ts`: `const PORT = process.env.PORT || 3001`
      (Railway injects `$PORT` at runtime; hardcoded 3001 won't bind)
- [ ] Add `Procfile`: `web: node dist/index.js`
- [ ] Ensure `npm run build` compiles to `dist/` (check `tsconfig.json` `outDir`)
- [ ] Push to GitHub, connect repo to Railway, add all backend env vars
- **Commit:** `chore: add Procfile and ensure PORT uses process.env for Railway`

#### Deploy frontend to Vercel
- [ ] Set `REACT_APP_API_URL` in Vercel project settings to Railway URL
- [ ] Set all `REACT_APP_*` env vars in Vercel
- [ ] `vercel --prod` from `/client`
- **Commit:** none needed (env vars are in Vercel dashboard)

#### Supabase production setup
All SQL is in `manual_actions.txt` and `README.md`. Remaining DB work:
- [ ] Run `profiles` table + `handle_new_user` trigger SQL (if not done)
- [ ] Add missing columns to profiles: `onboarding_completed BOOLEAN DEFAULT false`,
      `is_demo BOOLEAN DEFAULT false`
- [ ] Run `messages` table SQL
- [ ] Enable Realtime on `messages` table
- [ ] Create `avatars` storage bucket (public read, auth write)
- [ ] Set Auth Redirect URLs to include production domain

#### Seed demo users for matching
Without other real users, the matches page is empty. Need 8â€“10 realistic demo profiles
with pre-built goal trees to make matching feel real on day one.
- [ ] Create `POST /admin/seed-demo-users` endpoint (guarded by an admin secret header)
- [ ] Each demo user: realistic name, bio, goal tree covering 2â€“3 domains
- [ ] Mark with `is_demo: true` in profiles (add column above)
- [ ] Demo users appear in match results but have no real login
- **Files:** new `src/controllers/adminController.ts`, `src/routes/adminRoutes.ts`
- **Commit:** `feat: add demo user seed endpoint for beta testing`

#### Matching fallback for small datasets
The matching engine calls Gemini embeddings (expensive + slow) for every user pair.
With 5â€“20 users this is fine, but it fails completely when `GEMINI_API_KEY` is unset.
- [ ] Add fallback in `MatchingEngineService.calculateCompatibilityScore()`:
      if Gemini call fails â†’ score = (shared_domain_count / max_domains) Ã— 0.7
      + (1 - avg_progress_diff) Ã— 0.3
- [ ] Catch embedding errors gracefully (currently propagates and kills the match call)
- **File:** `src/services/MatchingEngineService.ts`
- **Commit:** `feat: domain-overlap fallback when Gemini embeddings unavailable`

---

### ðŸŸ¡ SHOULD HAVE â€” First week of beta

#### Empty-state CTAs
- [x] DashboardPage: "Set Up My Goals" CTA â†’ `/goal-selection` âœ…
- [x] GoalTreePage: full CTA card â†’ `/goal-selection` âœ…

#### "View Profile" for match cards
- [x] MatchesPage match cards: "Profile" button added âœ…
- [x] ProfilePage: read-only view when `:id` !== current user âœ…

#### Verify real-time chat end-to-end
- [ ] Open two browser sessions; log in as different users
- [ ] Send a message; verify it appears instantly without page refresh
- [ ] If not working: Supabase Realtime may need the messages table enabled (see above)

#### Wire feedback form to backend
- [x] Added `Authorization: Bearer` header to `handleSubmitFeedback` âœ…
- [x] Replaced `alert()` with `toast.success()` / `toast.error()` âœ…
- [x] `submittingFeedback` state prevents double-submission âœ…
- [ ] Test: grade a partner â†’ check that their goal weight changes in DB

#### Mobile responsiveness pass
- [ ] Navbar: add hamburger menu for mobile (collapse nav links into drawer)
- [ ] ChatRoom: input bar stays above keyboard on iOS (add `env(safe-area-inset-bottom)`)
- [ ] GoalTreePage: horizontal scroll wrapper for wide tree on small screens
- **Commit:** `fix: mobile responsiveness â€” navbar hamburger, chat input, goal tree`

---

### ðŸŸ¢ COULD HAVE â€” Polish / retention

#### Achievement creation from GoalTreePage (Step 10 partial)
- [x] Peer-verified goal completion: click node â†’ pick verifier from DMs â†’ verifier sees card in chat â†’ Verify button sets goal to 100% âœ…
- [ ] On 100%: auto-create `POST /achievements` with `goalNodeId`, `title`, `domain`
- [ ] Toast: "ðŸ† Achievement unlocked!" + redirect to dashboard feed
- **Commit:** `feat: mark goal complete â†’ auto-create achievement`

#### Progress streaks (Step 13)
- [ ] Supabase: `last_activity_date DATE`, `current_streak INT DEFAULT 0` on profiles
- [ ] `goalController.ts`: update streak on every goal save
- [ ] DashboardPage: flame icon + streak count in welcome banner
- **Commit:** `feat: progress streaks â€” flame counter on dashboard`

#### Dashboard "Top Matches" widget
- [ ] Fetch top 3 matches on dashboard load
- [ ] Show small cards with avatar, name, compatibility %, "Message" CTA
- **Commit:** `feat: top matches widget on dashboard`

---

### ðŸ”µ FUTURE â€” Post-beta

#### Step 10 â€” Goal-Focused Match Chat
Full implementation (chat scoped to a shared goalNodeId, context banner, collaboration CTAs).
See detailed spec below.

#### Step 11 â€” Mutual Grading Prompt
Trigger feedback dialog after N messages or "End Session" button.
Both-sides submission before weight recalibration fires.

#### Step 12 â€” Guided Onboarding Interest Tree
`OnboardingPage` already has a domain-interest step. Enhance to full
hierarchical sub-goal selection + initial weight/progress setting.
The `GoalSelectionPage` already handles this well â€” may just need routing integration.

#### Step 14 â€” Community Challenges
Shared goal events, group accountability chats, completion badges.

#### Step 15 â€” Goal Tree Evolution History
Snapshot table, timeline view in AnalyticsPage, "rewind" to past tree state.

---

## Step Specs (future reference)

### Step 10 â€” Goal-Focused Match Chat

- Add `goal_node_id` column to `messages` Supabase table (SQL in `manual_actions.txt`)
- MatchesPage: "Start Collaboration" button (visible when score > 0.6)
  â†’ navigate to `/chat/:myId/:theirId?goalNodeId=<id>`
- ChatRoom: read `goalNodeId` from URL params, show shared goal banner at top
- `messageController`: store `goal_node_id` in insert; filter by it in getMessages
- ChatPage: list active collaborations grouped by goal node

### Step 11 â€” Mutual Grading

- Trigger feedback dialog after 15+ messages or "End Session" click
- Pre-fill `goalNodeId` from active chat context (from Step 10)
- Backend: track whether both parties have submitted; fire weight recalibration only when both done
- Show "Waiting for partner's feedback" pending state

### Step 12 â€” Guided Onboarding

- `GoalSelectionPage` already works â€” the key missing piece is the PrivateRoute guard
  redirecting to it after onboarding_completed is set (now implemented in Session 11)
- Enhancements: Step 2 = sub-goal picker per domain, Step 3 = initial weights

### Step 13 â€” Streaks

```sql
ALTER TABLE profiles ADD COLUMN last_activity_date DATE;
ALTER TABLE profiles ADD COLUMN current_streak INT DEFAULT 0;
```

Backend: after any goal update, check last_activity_date vs today.
If yesterday â†’ streak++. If >1 day ago â†’ streak = 1. If today â†’ no change.

### Step 14 â€” Community Challenges

```sql
CREATE TABLE challenges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  domain TEXT,
  deadline TIMESTAMPTZ,
  created_by UUID REFERENCES auth.users(id),
  participant_ids UUID[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### Step 15 â€” Goal Tree History

```sql
CREATE TABLE goal_tree_snapshots (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  snapshot JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

## Architectural Reminders

- **Auth flow:** Frontend uses anon Supabase client (JWT lives in browser localStorage).
  Backend API endpoints needing auth use `authenticateToken` middleware with the
  service-role client to verify JWT server-side.

- **Gemini embedding cost:** Each `getEmbedding()` call = 1 API request.
  MatchingEngine calls O(|A.nodes| Ã— |B.nodes|) times per user pair.
  Cache results in Redis or a `goal_embeddings` table for production scale.

- **Matching normalization (whitepaper Â§3.3):**
  S_AB = Î£(sim_ij Ã— w_i Ã— w_j) / Î£(w_i Ã— w_j)
  Only same-domain node pairs are compared.

- **Weight recalibration multipliers (whitepaper Â§3.5):**
  SUCCEEDED Ã— 0.8 | DISTRACTED Ã— 1.2 | LEARNED Ã— 0.9 | ADAPTED Ã— 1.05 | NOT_APPLICABLE Ã— 1.0

- **Free tier limits:** Max 3 root goals. AI Coaching, Advanced Analytics, unlimited goals
  are premium-only (enforced in `goalController` 403 and `AnalyticsPage` redirect).

- **Supabase RLS:** All tables have RLS. Backend uses service-role key (bypasses RLS).
  Frontend anon key is subject to RLS â€” always test both user perspectives.

- **API_URL pattern:** All frontend axios calls use `${API_URL}` from `client/src/lib/api.ts`.
  Change `REACT_APP_API_URL` in `client/.env` (local) or Vercel env vars (production).
  Never hardcode `localhost:3001` again.

- **MUI v7 Grid:** Use `<Grid size={{ xs: N, md: M }}>` not `<Grid item xs={N} md={M}>`.
  The old API was removed in MUI v7.
