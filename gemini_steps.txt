Hi Claude. You are building Praxis ‚Äî a social platform that matches users based on the semantic
similarity and progress-alignment of their hierarchical goal trees, then enables peer
accountability through real-time chat and mutual grading.

This file is your persistent memory across sessions. Update it every session: mark tasks done,
add new tasks, record decisions, and leave notes for your future self. Treat it as a logbook,
not just a checklist.

The whitepaper is the authoritative product spec. When in doubt, check it.
The companion file `manual_actions.txt` contains all required Supabase/Stripe setup SQL.
Feel free to delegate tasks to gemini-cli, which you can call by running "gemini" 
---

## Project Health (last updated: 2026-02-19 Session 13)

- Backend TypeScript: ‚úÖ 0 errors (`npx tsc --noEmit` from project root)
- Frontend TypeScript: ‚úÖ 0 errors (`npx tsc --noEmit` from `client/`)
- Frontend startup: ‚úÖ Compiles and runs on :3000 (face-api.js source map warnings suppressed by GENERATE_SOURCEMAP=false)
- Backend startup: ‚ùå Requires SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY in .env to start
- Git branch: `main` ‚Äî 12+ commits ahead of origin, pending push (SSH key not yet authorized on GitHub)
- Deployment: ‚ùå not yet deployed (Railway + Vercel ‚Äî full steps in manual_actions.txt Steps 11‚Äì12)

---

## Completed Sessions

### Sessions 1‚Äì9 ‚Äî Gemini CLI (foundation)

1. Infrastructure, README, initial compilation fixes
2. GoalTree visualization + editing (add/update/delete nodes, progress/weight sliders)
3. Profile enhancements (avatar upload to Supabase Storage, name/bio editing)
4. Dashboard with community achievements (upvote/downvote/comment, Supabase tables + triggers)
5. Stripe payment integration (Checkout, webhooks, `is_premium` gate)
6. Code commenting pass
7. GoalTreeComponent with Framer Motion expand/collapse animations
8. AI Coaching via Gemini generative model (premium-gated)
9. Advanced Analytics endpoints (premium-gated; `getComparisonData` is placeholder)

---

### Session 10 ‚Äî Claude Code (2026-02-19) ‚Äî Full Audit + Styling

**Phase 1 ‚Äî Critical bug fixes:**
- `src/index.ts`: Added 8 missing route imports (server crashed on start)
- `src/middleware/authenticateToken.ts`: Created from scratch (Supabase JWT verification)
- `src/types/express.d.ts`: Extend Express Request with `user?: { id: string }`
- `DashboardPage.tsx`: Fixed missing `commentsLoading` state, wrong `../models` import paths,
  added auth header to AI Coaching axios call
- `AnalyticsPage.tsx`: Added auth headers to all 5 analytics calls; fixed import paths
- `src/utils/appErrors.ts`: Fixed `catchAsync` to use proper `RequestHandler` return type
- `src/controllers/achievementController.ts`: Added null guards after Supabase inserts
- `src/controllers/analyticsController.ts`: Fixed `string | string[]` type cast

**Phase 2 ‚Äî Connect stub pages to real backend:**
- `GoalTreePage.tsx`: Replaced `exampleGoalTreeData` with real `GET /goals/:userId`.
  Added `buildFrontendTree()` to map backend flat nodes ‚Üí frontend tree
  (name‚Üítitle, progress 0-1‚Üí0-100, parentId flat array ‚Üí children tree)
- `MatchesPage.tsx`: Replaced mock data + fake scoring with real `GET /matches/:userId`
  + Supabase profile fetch per match

**Phase 3 ‚Äî Styling overhaul:**
- New MUI dark theme: #0A0B14 bg, #F59E0B primary (amber), #8B5CF6 secondary (violet)
- `GlassCard` component: glassmorphism Paper wrapper with `glow` + `glowColor` props
- Full redesigns: Navbar, HomePage, DashboardPage, GoalTreePage, MatchesPage,
  ProfilePage, UpgradePage, AnalyticsPage, LoginPage, SignupPage, ChatRoom

**Phase 4 ‚Äî Comments:** MatchingEngineService, EmbeddingService, feedbackController,
goalController, analyticsController, useUser hook, PrivateRoute

**Phase 5 ‚Äî Docs:** `claude_steps.txt` created, `manual_actions.txt` updated

---

### Session 13 ‚Äî Claude Code (2026-02-19) ‚Äî MatchesPage polish + run script + docs

**MatchesPage full rewrite:**
- `client/src/data/mockMatches.ts`: added `overallProgress` field (0-100) to all 7 profiles
- `MatchesPage.tsx`: goal progress bar tease (linear bar with %, color-coded); bio line-clamped
  to 3 lines; demo user Message click ‚Üí toast + redirect to /goals/:id instead of /chat/demo-X
- Empty state: two CTAs (Build goal tree + Upgrade for more matches)
- Removed unused `IconButton` import and unused `currentUserId` prop from `MatchCard`

**Startup:**
- `run_praxis.sh` created: checks env vars, reports which are missing and why they matter,
  kills stale processes on :3000/:3001, starts backend + frontend with PID tracking,
  writes to .logs/, graceful Ctrl+C cleanup
- Discovered: backend requires `SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY` to start.
  Frontend starts standalone on :3000 (with harmless face-api.js source map warnings,
  now suppressed by `GENERATE_SOURCEMAP=false` in client/.env)

**Docs:**
- `README.md`: complete rewrite ‚Äî what Praxis is, how matching works, current status table,
  quick start, first-run expectations, API routes, env var reference, architecture notes
- `manual_actions.txt`: full idiot-proof rewrite ‚Äî QUICK START section (4 steps to run locally),
  full numbered checklist, every step has WHERE+WHAT+SUCCESS, TROUBLESHOOTING section

**Note:** `gemini_steps.txt` was renamed to `claude` on disk by user; restored.

---

### Session 11 ‚Äî Claude Code (2026-02-19) ‚Äî Private Beta Sprint

**Fix 1 ‚Äî Chat route bug:**
- `routes.tsx`: `/chat/:user1Id/:user2Id` was pointing to `ChatPage` (conversation list)
  instead of `ChatRoom`. Fixed. Removed duplicate `/chat/:id` route.

**Fix 2 ‚Äî Supabase snake_case column names:**
- All chat code used camelCase (`senderId`, `receiverId`) but the `messages` table
  uses snake_case (`sender_id`, `receiver_id`)
- Fixed in: `messageController.ts` (queries + insert), `ChatPage.tsx` (.or() filter,
  field reads), `ChatRoom.tsx` (realtime filter, payload checks, message render)
- Added `msg.timestamp ?? msg.created_at` fallback

**Fix 3 ‚Äî Onboarding guard:**
- `User.ts`: Added `onboarding_completed?: boolean`
- `useUser.ts`: Maps `profile.onboarding_completed` into user object.
  Also refactored to `useCallback`, expose `refetch`, only re-fetch on
  `SIGNED_IN`/`USER_UPDATED` (not every token refresh)
- `PrivateRoute.tsx`: Redirects to `/onboarding` when `onboarding_completed === false`.
  Exempts `/onboarding` and `/goal-selection`. Loading state upgraded to centered
  `CircularProgress`.

**Fix 4 ‚Äî Replace hardcoded `localhost:3001` with env var:**
- Created `client/src/lib/api.ts` exporting `API_URL` constant
  (`REACT_APP_API_URL` env var with `http://localhost:3001` fallback)
- Updated 11 files: all `axios` calls now use template literal `${API_URL}/...`
- Added `REACT_APP_API_URL=http://localhost:3001` to `client/.env`
- `client/.env.example` already had it

**Docs:**
- `README.md`: Full rewrite. Accurate tech stack, directory structure, quick start,
  Supabase SQL setup (copy-paste ready), API route table, env var reference, deployment guide.
- `root/.env.example` created (backend env var template)
- Fixed import paths in 10+ files (GoalNodeComponent, GoalTreeComponent, GoalNodeDisplay,
  GoalTreeDisplay, GoalSelectionPage, IdentityVerificationPage, OnboardingPage, InitialGoalSetup)
- Fixed MUI v7 Grid API (`<Grid item xs={N}>` ‚Üí `<Grid size={{ xs: N }}>`) across all pages
- Fixed TypeScript arithmetic error in GoalNodeComponent (`theme.spacing(level * 2)`)
- Removed non-existent `Achievement.totalComments` reference in DashboardPage

---

## Environment Variables

### Backend (`/.env`)
- [x] STRIPE_SECRET_KEY
- [ ] SUPABASE_URL
- [ ] SUPABASE_SERVICE_ROLE_KEY
- [ ] GEMINI_API_KEY
- [ ] CLIENT_URL
- [ ] STRIPE_PRICE_ID
- [ ] STRIPE_WEBHOOK_SECRET
- [ ] PORT (defaults to 3001)

### Frontend (`/client/.env`)
- [x] REACT_APP_SUPABASE_URL
- [x] REACT_APP_SUPABASE_ANON_KEY
- [x] REACT_APP_STRIPE_PUBLISHABLE_KEY
- [x] REACT_APP_API_URL

See `.env.example` and `client/.env.example` for templates.
See `manual_actions.txt` for full Supabase + Stripe setup instructions.

---

## Active Roadmap

### üî¥ MUST HAVE ‚Äî Before beta invite goes out

#### Deploy backend to Railway
- [ ] Update `src/index.ts`: `const PORT = process.env.PORT || 3001`
      (Railway injects `$PORT` at runtime; hardcoded 3001 won't bind)
- [ ] Add `Procfile`: `web: node dist/index.js`
- [ ] Ensure `npm run build` compiles to `dist/` (check `tsconfig.json` `outDir`)
- [ ] Push to GitHub, connect repo to Railway, add all backend env vars
- **Commit:** `chore: add Procfile and ensure PORT uses process.env for Railway`

#### Deploy frontend to Vercel
- [ ] Set `REACT_APP_API_URL` in Vercel project settings to Railway URL
- [ ] Set all `REACT_APP_*` env vars in Vercel
- [ ] `vercel --prod` from `/client`
- **Commit:** none needed (env vars are in Vercel dashboard)

#### Supabase production setup
All SQL is in `manual_actions.txt` and `README.md`. Remaining DB work:
- [ ] Run `profiles` table + `handle_new_user` trigger SQL (if not done)
- [ ] Add missing columns to profiles: `onboarding_completed BOOLEAN DEFAULT false`,
      `is_demo BOOLEAN DEFAULT false`
- [ ] Run `messages` table SQL
- [ ] Enable Realtime on `messages` table
- [ ] Create `avatars` storage bucket (public read, auth write)
- [ ] Set Auth Redirect URLs to include production domain

#### Seed demo users for matching
Without other real users, the matches page is empty. Need 8‚Äì10 realistic demo profiles
with pre-built goal trees to make matching feel real on day one.
- [ ] Create `POST /admin/seed-demo-users` endpoint (guarded by an admin secret header)
- [ ] Each demo user: realistic name, bio, goal tree covering 2‚Äì3 domains
- [ ] Mark with `is_demo: true` in profiles (add column above)
- [ ] Demo users appear in match results but have no real login
- **Files:** new `src/controllers/adminController.ts`, `src/routes/adminRoutes.ts`
- **Commit:** `feat: add demo user seed endpoint for beta testing`

#### Matching fallback for small datasets
The matching engine calls Gemini embeddings (expensive + slow) for every user pair.
With 5‚Äì20 users this is fine, but it fails completely when `GEMINI_API_KEY` is unset.
- [ ] Add fallback in `MatchingEngineService.calculateCompatibilityScore()`:
      if Gemini call fails ‚Üí score = (shared_domain_count / max_domains) √ó 0.7
      + (1 - avg_progress_diff) √ó 0.3
- [ ] Catch embedding errors gracefully (currently propagates and kills the match call)
- **File:** `src/services/MatchingEngineService.ts`
- **Commit:** `feat: domain-overlap fallback when Gemini embeddings unavailable`

---

### üü° SHOULD HAVE ‚Äî First week of beta

#### Empty-state CTAs
- [ ] DashboardPage: if no goals ‚Üí show "Set up your goals" CTA card ‚Üí `/goal-selection`
- [ ] GoalTreePage: if no goals loaded ‚Üí show "You haven't set goals yet" + link
- **Commit:** `feat: empty state CTAs on dashboard and goal tree`

#### "View Profile" for match cards
- [ ] MatchesPage match cards: add "View Profile" link navigating to `/profile/:userId`
- [ ] ProfilePage: if `:id` param present and != current user ‚Üí show read-only view
      (hide edit controls, show public-facing info: name, bio, domains only)
- **Commit:** `feat: public profile view for matched users`

#### Verify real-time chat end-to-end
- [ ] Open two browser sessions; log in as different users
- [ ] Send a message; verify it appears instantly without page refresh
- [ ] If not working: Supabase Realtime may need the messages table enabled (see above)

#### Wire feedback form to backend
The ChatRoom already has the feedback UI (grade select + comment input).
It calls `POST /feedback` via axios but may be missing the auth header.
- [ ] Check `handleSubmitFeedback` in `ChatRoom.tsx` ‚Äî add auth header if missing
- [ ] Add `toast.success()` on submit; prevent double-submission (disable button)
- [ ] Test: grade a partner ‚Üí check that their goal weight changes in DB
- **Commit:** `fix: add auth header to ChatRoom feedback submission, disable on submit`

#### Mobile responsiveness pass
- [ ] Navbar: add hamburger menu for mobile (collapse nav links into drawer)
- [ ] ChatRoom: input bar stays above keyboard on iOS (add `env(safe-area-inset-bottom)`)
- [ ] GoalTreePage: horizontal scroll wrapper for wide tree on small screens
- **Commit:** `fix: mobile responsiveness ‚Äî navbar hamburger, chat input, goal tree`

---

### üü¢ COULD HAVE ‚Äî Polish / retention

#### Achievement creation from GoalTreePage (Step 10 partial)
- [ ] Each goal node: add "Mark Complete ‚úì" button when `progress === 100`
- [ ] On confirm: `POST /achievements` with `goalNodeId`, `title`, `domain`
- [ ] Toast: "üèÜ Achievement unlocked!" + redirect to dashboard feed
- **Commit:** `feat: mark goal complete ‚Üí auto-create achievement`

#### Progress streaks (Step 13)
- [ ] Supabase: `last_activity_date DATE`, `current_streak INT DEFAULT 0` on profiles
- [ ] `goalController.ts`: update streak on every goal save
- [ ] DashboardPage: flame icon + streak count in welcome banner
- **Commit:** `feat: progress streaks ‚Äî flame counter on dashboard`

#### Dashboard "Top Matches" widget
- [ ] Fetch top 3 matches on dashboard load
- [ ] Show small cards with avatar, name, compatibility %, "Message" CTA
- **Commit:** `feat: top matches widget on dashboard`

---

### üîµ FUTURE ‚Äî Post-beta

#### Step 10 ‚Äî Goal-Focused Match Chat
Full implementation (chat scoped to a shared goalNodeId, context banner, collaboration CTAs).
See detailed spec below.

#### Step 11 ‚Äî Mutual Grading Prompt
Trigger feedback dialog after N messages or "End Session" button.
Both-sides submission before weight recalibration fires.

#### Step 12 ‚Äî Guided Onboarding Interest Tree
`OnboardingPage` already has a domain-interest step. Enhance to full
hierarchical sub-goal selection + initial weight/progress setting.
The `GoalSelectionPage` already handles this well ‚Äî may just need routing integration.

#### Step 14 ‚Äî Community Challenges
Shared goal events, group accountability chats, completion badges.

#### Step 15 ‚Äî Goal Tree Evolution History
Snapshot table, timeline view in AnalyticsPage, "rewind" to past tree state.

---

## Step Specs (future reference)

### Step 10 ‚Äî Goal-Focused Match Chat

- Add `goal_node_id` column to `messages` Supabase table (SQL in `manual_actions.txt`)
- MatchesPage: "Start Collaboration" button (visible when score > 0.6)
  ‚Üí navigate to `/chat/:myId/:theirId?goalNodeId=<id>`
- ChatRoom: read `goalNodeId` from URL params, show shared goal banner at top
- `messageController`: store `goal_node_id` in insert; filter by it in getMessages
- ChatPage: list active collaborations grouped by goal node

### Step 11 ‚Äî Mutual Grading

- Trigger feedback dialog after 15+ messages or "End Session" click
- Pre-fill `goalNodeId` from active chat context (from Step 10)
- Backend: track whether both parties have submitted; fire weight recalibration only when both done
- Show "Waiting for partner's feedback" pending state

### Step 12 ‚Äî Guided Onboarding

- `GoalSelectionPage` already works ‚Äî the key missing piece is the PrivateRoute guard
  redirecting to it after onboarding_completed is set (now implemented in Session 11)
- Enhancements: Step 2 = sub-goal picker per domain, Step 3 = initial weights

### Step 13 ‚Äî Streaks

```sql
ALTER TABLE profiles ADD COLUMN last_activity_date DATE;
ALTER TABLE profiles ADD COLUMN current_streak INT DEFAULT 0;
```

Backend: after any goal update, check last_activity_date vs today.
If yesterday ‚Üí streak++. If >1 day ago ‚Üí streak = 1. If today ‚Üí no change.

### Step 14 ‚Äî Community Challenges

```sql
CREATE TABLE challenges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  domain TEXT,
  deadline TIMESTAMPTZ,
  created_by UUID REFERENCES auth.users(id),
  participant_ids UUID[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### Step 15 ‚Äî Goal Tree History

```sql
CREATE TABLE goal_tree_snapshots (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  snapshot JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

## Architectural Reminders

- **Auth flow:** Frontend uses anon Supabase client (JWT lives in browser localStorage).
  Backend API endpoints needing auth use `authenticateToken` middleware with the
  service-role client to verify JWT server-side.

- **Gemini embedding cost:** Each `getEmbedding()` call = 1 API request.
  MatchingEngine calls O(|A.nodes| √ó |B.nodes|) times per user pair.
  Cache results in Redis or a `goal_embeddings` table for production scale.

- **Matching normalization (whitepaper ¬ß3.3):**
  S_AB = Œ£(sim_ij √ó w_i √ó w_j) / Œ£(w_i √ó w_j)
  Only same-domain node pairs are compared.

- **Weight recalibration multipliers (whitepaper ¬ß3.5):**
  SUCCEEDED √ó 0.8 | DISTRACTED √ó 1.2 | LEARNED √ó 0.9 | ADAPTED √ó 1.05 | NOT_APPLICABLE √ó 1.0

- **Free tier limits:** Max 3 root goals. AI Coaching, Advanced Analytics, unlimited goals
  are premium-only (enforced in `goalController` 403 and `AnalyticsPage` redirect).

- **Supabase RLS:** All tables have RLS. Backend uses service-role key (bypasses RLS).
  Frontend anon key is subject to RLS ‚Äî always test both user perspectives.

- **API_URL pattern:** All frontend axios calls use `${API_URL}` from `client/src/lib/api.ts`.
  Change `REACT_APP_API_URL` in `client/.env` (local) or Vercel env vars (production).
  Never hardcode `localhost:3001` again.

- **MUI v7 Grid:** Use `<Grid size={{ xs: N, md: M }}>` not `<Grid item xs={N} md={M}>`.
  The old API was removed in MUI v7.
